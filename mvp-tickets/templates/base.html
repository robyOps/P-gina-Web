{% load static %}
{% load roles notifications %} {# filtros personalizados #}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Helpdesk{% endblock %}</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@2.0.3"></script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

  <style>
    :root {
      color-scheme: light;
    }
    .btn {
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.15);
    }
    .btn:active {
      transform: scale(0.98);
    }
    .nav-admin summary::-webkit-details-marker {
      display: none;
    }
    .nav-admin__toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      background: transparent;
      color: inherit;
      transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .nav-admin__toggle:hover {
      color: #fdba74;
    }
    .nav-admin[open] .nav-admin__toggle {
      background: rgba(255, 255, 255, 0.25);
      color: #ffffff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.18);
    }
    .nav-admin__menu {
      z-index: 60;
      min-width: 14rem;
      border-radius: 1.25rem;
      overflow: hidden;
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 24px 45px rgba(30, 64, 175, 0.18);
      border: 1px solid rgba(191, 219, 254, 0.7);
    }
    .nav-admin__menu a {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      padding: 0.75rem 1.1rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: #1f2937;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .nav-admin__menu a:hover {
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
    }
    .nav-user summary::-webkit-details-marker {
      display: none;
    }
    .nav-user__toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 9999px;
      font-size: 1.1rem;
      cursor: pointer;
      color: inherit;
      border: 1px solid transparent;
      transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease,
        border-color 0.2s ease;
    }
    .nav-user__toggle:hover {
      color: #fdba74;
    }
    .nav-user[open] .nav-user__toggle {
      background: rgba(255, 255, 255, 0.25);
      color: #ffffff;
      border-color: rgba(248, 250, 252, 0.4);
      box-shadow: 0 14px 35px rgba(15, 23, 42, 0.22);
    }
    .nav-user__menu {
      z-index: 60;
      min-width: 12rem;
      border-radius: 1.15rem;
      overflow: hidden;
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 22px 42px rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .nav-user__menu a {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.65rem 0.95rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: #1f2937;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .nav-user__menu a:hover {
      background: rgba(59, 130, 246, 0.12);
      color: #1d4ed8;
    }
    .page-hero {
      padding: clamp(0.85rem, 1.5vw, 1.35rem) clamp(1rem, 4vw, 1.75rem);
      border-radius: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }
    .page-hero > * {
      gap: 0.65rem;
    }
    .page-hero h1 {
      font-size: clamp(1.35rem, 1rem + 0.6vw, 1.75rem);
      line-height: 1.2;
    }
    .page-hero p {
      font-size: 0.85rem;
      line-height: 1.45;
    }
    .page-hero .page-hero__meta {
      font-size: 0.7rem;
      letter-spacing: 0.18em;
      padding: 0.35rem 0.65rem;
      border-radius: 9999px;
    }
    .faq-category-chip[data-active="true"] {
      background: rgba(238, 242, 255, 0.95);
      border-color: #c7d2fe;
      color: #3730a3;
      box-shadow: inset 0 0 0 1px rgba(79, 70, 229, 0.25);
    }
    .primary-nav__toggle::-webkit-details-marker {
      display: none;
    }
    .primary-nav__toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.08);
      color: inherit;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }
    .primary-nav__toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.25);
      background: rgba(255, 255, 255, 0.18);
    }
    .primary-nav__panel {
      z-index: 70;
      width: min(18rem, calc(100vw - 1.5rem));
      border-radius: 1.25rem;
      overflow: hidden;
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 25px 50px rgba(15, 23, 42, 0.22);
      border: 1px solid rgba(191, 219, 254, 0.7);
    }
  </style>
  <script>
    (function () {
      const historyApi = window.history;
      if (historyApi && typeof historyApi.scrollRestoration === 'string') {
        historyApi.scrollRestoration = 'manual';
      }

      const storageKeyBase = `scroll-position:${window.location.pathname}`;
      const storageKeyLegacy = `${storageKeyBase}${window.location.search}`;
      const storageKeys = [storageKeyBase, storageKeyLegacy];
      let restored = false;

      const parseOffset = (value) => {
        const parsed = parseInt(value, 10);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const applyOffset = (offset) => {
        if (!Number.isFinite(offset)) {
          return;
        }
        let attempts = 0;
        const maxAttempts = 8;
        const target = Math.max(0, Math.round(offset));

        const tick = () => {
          const current = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
          if (Math.abs(current - target) <= 1 || attempts >= maxAttempts) {
            window.scrollTo(0, target);
            return;
          }
          attempts += 1;
          window.scrollTo(0, target);
          requestAnimationFrame(tick);
        };

        requestAnimationFrame(tick);
      };

      const restoreScroll = () => {
        if (restored) {
          return;
        }
        restored = true;
        try {
          for (const key of storageKeys) {
            const raw = sessionStorage.getItem(key);
            if (raw === null) {
              continue;
            }
            const offset = parseOffset(raw);
            sessionStorage.removeItem(key);
            if (offset !== null) {
              applyOffset(offset);
              break;
            }
          }
        } catch (error) {
          /* ignore storage issues */
        }
      };

      restoreScroll();

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', restoreScroll, { once: true });
      }

      window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
          restored = false;
          restoreScroll();
        }
      });

      const saveScroll = () => {
        try {
          const offset = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
          sessionStorage.setItem(storageKeyBase, String(Math.max(0, Math.round(offset))));
          if (storageKeyLegacy !== storageKeyBase) {
            sessionStorage.removeItem(storageKeyLegacy);
          }
        } catch (error) {
          /* ignore storage issues */
        }
      };

      window.addEventListener('beforeunload', saveScroll, { capture: true });
      document.addEventListener('submit', saveScroll, { capture: true });

      document.addEventListener(
        'click',
        (event) => {
          const target = event.target instanceof Element ? event.target.closest('[data-preserve-scroll]') : null;
          if (target) {
            saveScroll();
          }
          const reset = event.target instanceof Element ? event.target.closest('[data-reset-scroll]') : null;
          if (reset) {
            try {
              sessionStorage.removeItem(storageKeyBase);
              if (storageKeyLegacy !== storageKeyBase) {
                sessionStorage.removeItem(storageKeyLegacy);
              }
            } catch (error) {
              /* ignore storage issues */
            }
          }
        },
        { capture: true }
      );
    })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const mobileMenus = document.querySelectorAll('details[data-mobile-nav]');
      if (!mobileMenus.length) {
        return;
      }

      const closeMenu = (menu) => {
        if (menu.hasAttribute('open')) {
          menu.removeAttribute('open');
        }
      };

      mobileMenus.forEach((menu) => {
        const links = menu.querySelectorAll('[data-mobile-nav-link]');
        links.forEach((link) => {
          link.addEventListener('click', () => closeMenu(menu));
        });
      });

      document.addEventListener('click', (event) => {
        mobileMenus.forEach((menu) => {
          if (!menu.contains(event.target)) {
            closeMenu(menu);
          }
        });
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          mobileMenus.forEach(closeMenu);
        }
      });
    });
  </script>
  {% block head_extra %}{% endblock %}
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-gradient-to-r from-indigo-600 to-blue-500 text-white shadow">
    <div class="mx-auto w-full max-w-screen-2xl px-4 py-3 sm:px-6 lg:px-8">
      <div class="flex flex-wrap items-center gap-4 md:gap-6">
        <div class="order-1 flex flex-1 items-center gap-3 md:gap-5">
          {% if request.user.is_authenticated %}
          <details class="relative md:hidden" data-mobile-nav>
            <summary class="primary-nav__toggle" aria-label="Abrir menú">
              <i class="bi bi-list"></i>
              <span class="sr-only">Abrir menú principal</span>
            </summary>
            <div class="primary-nav__panel absolute left-0 top-full mt-3 p-3 text-slate-700">
              <nav class="flex flex-col gap-1" aria-label="Menú principal">
                {% with current_path=request.path %}
                  {% include "partials/_primary_nav_links.html" with link_base_class="rounded-lg px-3 py-2 text-sm font-medium transition-colors" link_active_class="bg-slate-900 text-white shadow-sm" link_inactive_class="text-slate-700 hover:bg-slate-100 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400" nav_data_attribute='data-mobile-nav-link="true"' %}
                {% endwith %}
              </nav>
            </div>
          </details>
          {% endif %}
          <a href="{% url 'dashboard' %}" class="flex items-center gap-1 text-xl font-bold tracking-tight sm:text-2xl">
            <span class="text-white">Coyahue</span>
            <span class="text-black">Helpdesk</span>
          </a>
        </div>
        {% if request.user.is_authenticated %}
        {% with current_path=request.path %}
        <nav class="order-3 hidden w-full items-center justify-center gap-2 text-sm md:order-2 md:flex md:w-auto md:justify-start" aria-label="Secciones principales">
          <div class="flex flex-col gap-1 rounded-2xl border border-white/20 bg-white/10 p-2 shadow-lg ring-1 ring-white/20 backdrop-blur md:flex-row md:items-center md:gap-2 md:rounded-none md:border-0 md:bg-transparent md:p-0 md:shadow-none md:ring-0">
            {% include "partials/_primary_nav_links.html" with link_base_class="rounded-lg px-3 py-2 text-sm font-medium transition-colors" link_active_class="bg-white/25 text-white font-semibold shadow-sm" link_inactive_class="text-white/80 hover:text-orange-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white/50" %}
          </div>
        </nav>
        {% endwith %}
        {% endif %}
        <div class="order-2 flex w-full flex-wrap items-center justify-end gap-3 text-sm text-white/90 md:order-3 md:w-auto md:flex-nowrap md:gap-6">
          {% if request.user.is_authenticated %}
            {% can_access_admin_panel as show_admin_panel %}
            {% if show_admin_panel %}
              <details class="nav-admin relative z-40 flex-shrink-0">
                <summary class="nav-admin__toggle">
                  <i class="bi bi-sliders"></i>
                  Admin Panel
                </summary>
                <div class="nav-admin__menu absolute right-0 mt-3">
                  {% if perms.auth.view_user or perms.auth.change_user %}<a href="{% url 'accounts:users_list' %}"><i class="bi bi-people"></i>Usuarios</a>{% endif %}
                  {% if perms.auth.view_group or perms.auth.change_group %}<a href="{% url 'accounts:roles_list' %}"><i class="bi bi-person-gear"></i>Roles</a>{% endif %}
                  {% if perms.catalog.view_category %}<a href="{% url 'categories_list' %}"><i class="bi bi-diagram-3"></i>Categorías</a>{% endif %}
                  {% if perms.catalog.view_subcategory %}<a href="{% url 'subcategories_list' %}"><i class="bi bi-diagram-2"></i>Subcategorías</a>{% endif %}
                  {% if perms.catalog.view_priority %}<a href="{% url 'priorities_list' %}"><i class="bi bi-lightning"></i>Prioridades</a>{% endif %}
                  {% if perms.catalog.view_area %}<a href="{% url 'areas_list' %}"><i class="bi bi-layers"></i>Áreas</a>{% endif %}
                  {% if perms.tickets.view_autoassignrule %}<a href="{% url 'auto_rules_list' %}"><i class="bi bi-magic"></i>Auto-asignación</a>{% endif %}
                  {% if perms.tickets.view_eventlog or perms.admin.view_logentry or request.user.is_staff %}<a href="{% url 'logs_list' %}"><i class="bi bi-clipboard-pulse"></i>Logs</a>{% endif %}
                </div>
              </details>
            {% endif %}
            <a href="{% url 'notifications_list' %}" class="relative inline-flex items-center justify-center rounded-full p-2 transition-colors hover:bg-white/10" aria-label="Notificaciones">
              <i class="bi bi-bell"></i>
              {% unread_notifications_count as notif_count %}
              {% if notif_count %}
                <span class="absolute -top-1.5 -right-1.5 rounded-full bg-red-500 px-1 text-xs text-white">{{ notif_count }}</span>
              {% endif %}
            </a>
            <span class="text-sm">Hola, <span class="font-medium">{{ request.user.username }}</span></span>
            <details class="nav-user relative">
              <summary class="nav-user__toggle" aria-label="Opciones de cuenta">
                <i class="bi bi-gear"></i>
                <span class="sr-only">Opciones de cuenta</span>
              </summary>
              <div class="nav-user__menu absolute right-0 mt-3" role="menu">
                <a href="{% url 'account_password_change' %}" role="menuitem">
                  <i class="bi bi-key"></i>
                  <span>Cambiar contraseña</span>
                </a>
              </div>
            </details>
            <form action="{% url 'logout' %}" method="post" class="w-full md:w-auto">
              {% csrf_token %}
              <button type="submit" class="w-full rounded-full border border-white/30 px-3 py-1.5 text-left text-sm font-medium transition hover:border-white/60 hover:bg-white/10 md:w-auto md:text-center">Salir</button>
            </form>
          {% else %}
            {% if request.resolver_match.url_name != 'login' %}
              <a href="{% url 'login' %}" class="rounded-full border border-white/30 px-3 py-1.5 text-sm font-medium transition hover:border-white/60 hover:bg-white/10">Ingresar</a>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </header>


  <main class="w-full max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    {# --- Mensajes flash --- #}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for m in messages %}
          <div class="px-3 py-2 rounded text-sm
              {% if m.tags == 'error' %}bg-red-50 text-red-700 border border-red-200
              {% elif m.tags == 'warning' %}bg-yellow-50 text-yellow-700 border border-yellow-200
              {% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
            {{ m }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>

  {% block body_extra %}{% endblock %}
</body>
</html>


