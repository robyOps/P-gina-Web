<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Reporte de tickets</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "DejaVu Sans", Arial, Helvetica, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
      color: #0b1330;
      font-size: 12px;
      margin: 0;
      padding: 26px;
      line-height: 1.5;
    }
    .page {
      max-width: 1120px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 20px 70px rgba(15, 23, 42, 0.16);
      overflow: hidden;
    }
    header {
      padding: 26px 28px 24px;
      background: radial-gradient(circle at 20% 20%, rgba(96, 165, 250, 0.24), transparent 32%),
                  radial-gradient(circle at 80% 0%, rgba(139, 92, 246, 0.2), transparent 38%),
                  linear-gradient(120deg, #0b1024 0%, #0d1229 22%, #0b1024 100%);
      color: #f8fafc;
      position: relative;
      isolation: isolate;
    }
    header::after {
      content: "";
      position: absolute;
      inset: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      pointer-events: none;
    }
    .header-grid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 18px; align-items: center; }
    .eyebrow { display: inline-flex; padding: 6px 12px; border-radius: 999px; background: rgba(255,255,255,0.16); color: #e0e7ff; letter-spacing: 0.26em; font-weight: 800; font-size: 10px; text-transform: uppercase; margin-bottom: 10px; backdrop-filter: blur(6px); }
    h1 { margin: 0 0 10px; font-size: 26px; letter-spacing: -0.02em; color: #f8fafc; text-shadow: 0 1px 8px rgba(0,0,0,0.2); }
    .subtitle { margin: 0; font-size: 13px; color: #e2e8f0; max-width: 520px; }
    .meta { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; color: #e5e7eb; }
    .chip { background: rgba(255,255,255,0.12); color: #f8fafc; border-radius: 10px; padding: 7px 11px; font-weight: 600; font-size: 11px; border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 10px 30px rgba(15,23,42,0.28); }
    .summary-box { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 14px; padding: 12px 14px; backdrop-filter: blur(6px); }
    .summary-box h3 { margin: 0 0 6px; font-size: 12px; letter-spacing: 0.12em; text-transform: uppercase; color: #e5e7eb; }
    .summary-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 6px; }
    .summary-list li { display: flex; justify-content: space-between; font-size: 12px; color: #f1f5f9; border-bottom: 1px dashed rgba(226,232,240,0.26); padding-bottom: 4px; }
    .summary-list li:last-child { border-bottom: none; padding-bottom: 0; }
    main { padding: 22px 24px 26px; }

    /* Sección filtros */
    .section { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 14px 16px; box-shadow: 0 12px 32px rgba(15, 23, 42, 0.05); margin-bottom: 14px; }
    .section-title { margin: 0 0 8px; font-size: 14px; color: #0f172a; display: flex; align-items: center; gap: 6px; letter-spacing: -0.01em; }
    .section-title span { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #22c55e); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12); }
    .muted { color: #475569; font-size: 11px; }
    .pill-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    .pill { background: #eef2ff; color: #312e81; border: 1px solid #c7d2fe; border-radius: 10px; padding: 6px 10px; font-weight: 700; font-size: 11px; }
    .pill.dark { background: #ecfeff; color: #0f172a; border-color: #bae6fd; }

    /* KPI Cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 12px; margin: 10px 0 14px; }
    .kpi { position: relative; background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 14px; padding: 14px 16px; box-shadow: 0 14px 34px rgba(15, 23, 42, 0.08); overflow: hidden; }
    .kpi::after { content: ""; position: absolute; right: -18px; top: -18px; width: 90px; height: 90px; background: radial-gradient(circle, rgba(99, 102, 241, 0.16), transparent 60%); transform: rotate(25deg); }
    .kpi-label { font-size: 11px; letter-spacing: 0.14em; text-transform: uppercase; color: #475569; margin-bottom: 6px; }
    .kpi-value { font-size: 24px; font-weight: 800; margin: 2px 0 6px; color: #0f172a; }
    .kpi-note { font-size: 11px; color: #475569; }

    .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin: 4px 0 12px; }
    .status-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px 12px; background: #f8fafc; box-shadow: inset 0 1px 0 rgba(255,255,255,0.8); }
    .status-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.14em; color: #475569; margin-bottom: 4px; }
    .status-value { font-size: 18px; font-weight: 800; color: #0f172a; }
    .status-note { font-size: 11px; color: #64748b; }

    /* Tablas y tarjetas */
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; }
    .card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 12px 14px; box-shadow: 0 12px 28px rgba(15, 23, 42, 0.06); }
    .card h3 { margin: 0 0 8px; font-size: 13px; color: #0f172a; letter-spacing: -0.01em; }
    table { width: 100%; border-collapse: collapse; margin-top: 6px; font-size: 12px; }
    th { text-align: left; background: #0f172a; color: #e2e8f0; letter-spacing: 0.08em; text-transform: uppercase; font-size: 10px; padding: 8px 9px; border: 1px solid #0f172a; }
    td { padding: 8px 9px; border: 1px solid #e2e8f0; color: #0f172a; }
    tr:nth-child(even) td { background: #f8fafc; }
    .empty { text-align: center; color: #94a3b8; padding: 12px 8px; }

    /* Barras de progreso */
    .bar-row { display: grid; grid-template-columns: 1fr 70px; gap: 10px; align-items: center; margin-bottom: 8px; }
    .bar-label { font-weight: 700; color: #0f172a; font-size: 11px; }
    .bar { position: relative; width: 100%; height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; border: 1px solid #e2e8f0; }
    .bar-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #6366f1, #22c55e); }
    .bar-fill.secondary { background: linear-gradient(90deg, #0ea5e9, #2563eb); }
    .tag { display: inline-block; padding: 4px 8px; border-radius: 10px; background: #eef2ff; color: #312e81; font-weight: 700; font-size: 10px; letter-spacing: 0.05em; text-transform: uppercase; text-align: center; }

    /* Notas */
    .note { border-left: 3px solid #22c55e; padding-left: 10px; font-size: 12px; color: #15803d; margin: 12px 0 0; background: #f0fdf4; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-grid">
        <div>
          <div class="eyebrow">Reporte de tickets</div>
          <h1>{{ type_label }}</h1>
          <p class="subtitle">Informe listo para compartir con tu equipo y tomar decisiones.</p>
          <div class="meta">
            <span class="chip">Generado el {{ generated_at|date:"d/m/Y H:i" }}</span>
            <span class="chip">Total: {{ total }}</span>
            {% if from or to %}<span class="chip">Rango: {{ from|default:"—" }} → {{ to|default:"—" }}</span>{% endif %}
            {% if tech_filter %}<span class="chip">Técnico: {{ tech_filter }}</span>{% endif %}
          </div>
        </div>
        <div class="summary-box">
          <h3>Resumen ejecutivo</h3>
          <ul class="summary-list">
            <li><span>Tipo de reporte</span><strong>{{ type_label }}</strong></li>
            <li><span>Tickets analizados</span><strong>{{ total }}</strong></li>
            <li><span>Promedio resolución</span><strong>{{ avg_hours|default_if_none:"—" }} h</strong></li>
            {% if from or to %}<li><span>Periodo</span><strong>{{ from|default:"—" }} → {{ to|default:"—" }}</strong></li>{% endif %}
          </ul>
        </div>
      </div>
    </header>

    <main>
      <section class="section">
        <h2 class="section-title"><span></span>Filtros aplicados</h2>
        <div class="pill-row">
          {% for f in filters_applied %}
            <span class="pill dark"><strong>{{ f.label }}:</strong> {{ f.value }}</span>
          {% empty %}
            <span class="pill">Sin filtros adicionales · Rango mensual por defecto</span>
          {% endfor %}
        </div>
      </section>

      <section class="kpi-grid">
        <article class="kpi">
          <div class="kpi-label">Tickets totales</div>
          <div class="kpi-value">{{ total }}</div>
          <div class="kpi-note">Resultados después de aplicar los filtros.</div>
        </article>
        <article class="kpi">
          <div class="kpi-label">Promedio de resolución</div>
          <div class="kpi-value">{{ avg_hours|default_if_none:"—" }} h</div>
          <div class="kpi-note">Solo tickets cerrados dentro del rango.</div>
        </article>
        {% if from or to %}
        <article class="kpi">
          <div class="kpi-label">Periodo analizado</div>
          <div class="kpi-value" style="font-size:14px;">{{ from|default:"—" }} → {{ to|default:"—" }}</div>
          <div class="kpi-note">Fechas límite consideradas.</div>
        </article>
        {% endif %}
      </section>

      <section class="section">
        <h2 class="section-title"><span></span>Estado y carga de trabajo</h2>
        <div class="status-grid">
          {% for name, count in by_status.items %}
            <article class="status-card">
              <div class="status-label">{{ name }}</div>
              <div class="status-value">{{ count|default:"0" }}</div>
              <div class="status-note">{{ total }} tickets analizados · {{ name }}</div>
            </article>
          {% empty %}
            <p class="muted">No hay tickets en el rango indicado.</p>
          {% endfor %}
        </div>
      </section>

      {% with status_data=by_status priority_data=by_priority %}
      <section class="card-grid" style="margin-bottom:12px;">
        <article class="card">
          <h3>Estado de tickets</h3>
          {% for name, count in status_data.items %}
            <div class="bar-row">
              <div class="bar-label">{{ name }}</div>
              <div class="bar">
                <div class="bar-fill" style="width:{% widthratio count total 100 %}%;"></div>
              </div>
              <div class="tag">{{ count }}</div>
            </div>
          {% empty %}
            <p class="muted">Sin datos disponibles para el rango seleccionado.</p>
          {% endfor %}
        </article>
        <article class="card">
          <h3>Distribución de prioridades</h3>
          {% for row in priority_data %}
            <div class="bar-row">
              <div class="bar-label">{{ row.priority__name|default:"Sin prioridad" }}</div>
              <div class="bar">
                <div class="bar-fill secondary" style="width:{% widthratio row.count total 100 %}%;"></div>
              </div>
              <div class="tag">{{ row.count }}</div>
            </div>
          {% empty %}
            <p class="muted">Aún no hay prioridades registradas en el período.</p>
          {% endfor %}
        </article>
      </section>
      {% endwith %}

      {% if type == 'promedio' %}
        <section class="section">
          <h2 class="section-title"><span></span>Tiempo promedio</h2>
          <p class="muted">{{ avg_hours|default_if_none:"—" }} horas en promedio considerando solo tickets resueltos en el periodo.</p>
        </section>
      {% elif type == 'productividad' %}
        <section class="card-grid">
          <article class="card">
            <h3>Resumen de productividad</h3>
            <table>
              <tbody>
                <tr><td class="muted">Tickets cerrados</td><td><strong>{{ productivity_summary.total_closed|default:"0" }}</strong></td></tr>
                <tr><td class="muted">Promedio de resolución</td><td>{{ productivity_summary.avg_hours|default:"—" }} h</td></tr>
                <tr><td class="muted">Técnico con más cierres</td><td>{{ productivity_summary.top_tech|default:"—" }}</td></tr>
                <tr><td class="muted">Promedio más rápido</td><td>{% if productivity_summary.fastest_tech %}{{ productivity_summary.fastest_tech }} · {{ productivity_summary.fastest_avg }} h{% else %}—{% endif %}</td></tr>
              </tbody>
            </table>
          </article>
          <article class="card">
            <h3>Top técnicos (cerrados)</h3>
            <table>
              <thead><tr><th>Técnico</th><th>Cerrados</th><th>Promedio (h)</th><th>Último cierre</th></tr></thead>
              <tbody>
                {% for row in productivity_rows %}
                  <tr>
                    <td>{{ row.tech }}</td>
                    <td>{{ row.closed }}</td>
                    <td>{{ row.avg_hours|default:"—" }}</td>
                    <td>{% if row.last_closed %}{{ row.last_closed|date:"d/m/Y H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="empty">Sin técnicos con cierres en el rango filtrado.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </article>
        </section>
      {% elif type == 'categoria' %}
        <section class="card">
          <h3>Tickets por categoría</h3>
          <table>
            <thead><tr><th>Categoría</th><th>Cantidad</th></tr></thead>
            <tbody>
              {% for row in by_category %}
                <tr><td>{{ row.category__name|default:"Sin categoría" }}</td><td>{{ row.count }}</td></tr>
              {% empty %}<tr><td colspan="2" class="empty">Sin datos</td></tr>{% endfor %}
            </tbody>
          </table>
        </section>
        <section class="card" style="margin-top:12px;">
          <h3>Detalle por subcategoría</h3>
          <table>
            <thead><tr><th>Categoría</th><th>Subcategoría</th><th>Cantidad</th></tr></thead>
            <tbody>
              {% for row in by_subcategory %}
                <tr>
                  <td>{{ row.category__name|default:"Sin categoría" }}</td>
                  <td>{% if row.subcategory__name %}{{ row.subcategory__name }}{% else %}<span class="muted">Sin subcategoría</span>{% endif %}</td>
                  <td>{{ row.count }}</td>
                </tr>
              {% empty %}<tr><td colspan="3" class="empty">Sin datos</td></tr>{% endfor %}
            </tbody>
          </table>
        </section>
      {% elif type == 'tecnico' %}
        <section class="card">
          <h3>Tickets por técnico</h3>
          <table>
            <thead><tr><th>Técnico</th><th>Cantidad</th></tr></thead>
            <tbody>
              {% for row in by_tech %}
                <tr><td>{{ row.assigned_to__username|default:"Sin asignar" }}</td><td>{{ row.count }}</td></tr>
              {% empty %}<tr><td colspan="2" class="empty">Sin datos</td></tr>{% endfor %}
            </tbody>
          </table>
        </section>
      {% elif type == 'urgencia' %}
        <section class="card">
          <h3>Tickets de urgencia</h3>
          <table>
            <thead><tr><th>Código</th><th>Título</th><th>Estado</th><th>Prioridad</th><th>Asignado a</th></tr></thead>
            <tbody>
              {% for row in urgent_tickets %}
                <tr>
                  <td>{{ row.code }}</td>
                  <td>{{ row.title }}</td>
                  <td>{{ row.status }}</td>
                  <td>{{ row.priority__name|default:"—" }}</td>
                  <td>{{ row.assigned_to__username|default:"Sin asignar" }}</td>
                </tr>
              {% empty %}<tr><td colspan="5" class="empty">Sin datos</td></tr>{% endfor %}
            </tbody>
          </table>
        </section>
      {% else %}
        <section class="card-grid">
          <article class="card">
            <h3>Tickets por estado</h3>
            <table>
              <thead><tr><th>Estado</th><th>Cantidad</th></tr></thead>
              <tbody>
                {% for name, count in by_status.items %}
                  <tr><td>{{ name }}</td><td>{{ count }}</td></tr>
                {% empty %}<tr><td colspan="2" class="empty">Sin datos</td></tr>{% endfor %}
              </tbody>
            </table>
          </article>
          <article class="card">
            <h3>Tickets por prioridad</h3>
            <table>
              <thead><tr><th>Prioridad</th><th>Cantidad</th></tr></thead>
              <tbody>
                {% for row in by_priority %}
                  <tr><td>{{ row.priority__name|default:"Sin prioridad" }}</td><td>{{ row.count }}</td></tr>
                {% empty %}<tr><td colspan="2" class="empty">Sin datos</td></tr>{% endfor %}
              </tbody>
            </table>
          </article>
        </section>
        <section class="card-grid" style="margin-top:12px;">
          <article class="card">
            <h3>Categorías</h3>
            <table>
              <thead><tr><th>Categoría</th><th>Cantidad</th></tr></thead>
              <tbody>
                {% for row in by_category %}
                  <tr><td>{{ row.category__name|default:"Sin categoría" }}</td><td>{{ row.count }}</td></tr>
                {% empty %}<tr><td colspan="2" class="empty">Sin datos</td></tr>{% endfor %}
              </tbody>
            </table>
          </article>
          <article class="card">
            <h3>Subcategorías</h3>
            <table>
              <thead><tr><th>Categoría</th><th>Subcategoría</th><th>Cantidad</th></tr></thead>
              <tbody>
                {% for row in by_subcategory %}
                  <tr>
                    <td>{{ row.category__name|default:"Sin categoría" }}</td>
                    <td>{% if row.subcategory__name %}{{ row.subcategory__name }}{% else %}<span class="muted">Sin subcategoría</span>{% endif %}</td>
                    <td>{{ row.count }}</td>
                  </tr>
                {% empty %}<tr><td colspan="3" class="empty">Sin datos</td></tr>{% endfor %}
              </tbody>
            </table>
          </article>
        </section>
      {% endif %}

      <p class="note">Reporte generado automáticamente. Si detectas datos inesperados, revisa los filtros y vuelve a exportar.</p>
    </main>
  </div>
</body>
</html>
