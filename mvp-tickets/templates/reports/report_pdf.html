<!doctype html>
{% load static %}
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Reporte de tickets</title>
  <link rel="stylesheet" href="{% static 'css/report_pdf.css' %}">
</head>
<body>
  <div class="header">
    <div>
      <h1>Reporte de tickets</h1>
      <div class="muted">{{ type_label }}</div>
      <div class="filters">
        <span><strong>Rango:</strong> {{ from|default:"—" }} → {{ to|default:"—" }}</span>
        {% if tech_filter %}<span><strong>Técnico:</strong> {{ tech_filter }}</span>{% endif %}
      </div>
      <div class="badge-row" style="margin-top: 3mm;">
        {% for item in filters_applied %}
          <span class="badge">{{ item.label }}: {{ item.value }}</span>
        {% empty %}
          <span class="filters-empty">Sin filtros adicionales.</span>
        {% endfor %}
      </div>
    </div>
    <div class="meta">
      <div><strong>Emisión:</strong> {{ generated_at|date:"d/m/Y H:i" }}</div>
      <div><strong>Total:</strong> {{ total }}</div>
      <div><strong>Tipo:</strong> {{ type|default:"general" }}</div>
    </div>
  </div>

  <div class="hr"></div>

  <div class="kpis">
    <div class="kpi">
      <div class="label">Total de tickets</div>
      <div class="value">{{ total }}</div>
      <div class="small">Resultados del período seleccionado</div>
    </div>
    {% for name, count in by_status.items %}
      {% if forloop.counter0 < 3 %}
        <div class="kpi">
          <div class="label">{{ name }}</div>
          <div class="value">{{ count|default:"0" }}</div>
          <div class="small">{% if total %}{% widthratio count total 100 %}% del total{% else %}0% del total{% endif %}</div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="section">
    <div class="table-title">
      <h2>Distribución por estado</h2>
      <span class="small">Total: {{ total }}</span>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Estado</th>
            <th class="num">Tickets</th>
            <th class="num">% del total</th>
          </tr>
        </thead>
        <tbody>
          {% for name, count in by_status.items %}
            <tr>
              <td>{{ name }}</td>
              <td class="num">{{ count|default:"0" }}</td>
              <td class="num">{% if total %}{% widthratio count total 100 %}%{% else %}0%{% endif %}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="center muted">No hay datos para los filtros seleccionados.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if by_priority %}
    <div class="section">
      <div class="table-title">
        <h2>Prioridades principales</h2>
        <span class="small">Ordenadas por volumen</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Prioridad</th>
              <th class="num">Tickets</th>
            </tr>
          </thead>
          <tbody>
            {% for row in by_priority %}
              <tr>
                <td>{{ row.priority__name|default:"Sin prioridad" }}</td>
                <td class="num">{{ row.count }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" class="center muted">Sin datos de prioridad.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if by_category %}
    <div class="section">
      <div class="table-title">
        <h2>Categorías principales</h2>
        <span class="small">Ordenado por cantidad</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Categoría</th>
              <th class="num">Tickets</th>
            </tr>
          </thead>
          <tbody>
            {% for row in by_category %}
              <tr>
                <td>{{ row.category__name|default:"Sin categoría" }}</td>
                <td class="num">{{ row.count }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" class="center muted">Sin datos de categoría.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if type == 'categoria' and by_subcategory %}
    <div class="section">
      <div class="table-title">
        <h2>Detalle por subcategoría</h2>
        <span class="small">Desglose dentro de cada categoría</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Categoría</th>
              <th>Subcategoría</th>
              <th class="num">Tickets</th>
            </tr>
          </thead>
          <tbody>
            {% for row in by_subcategory %}
              <tr>
                <td>{{ row.category__name|default:"Sin categoría" }}</td>
                <td>{% if row.subcategory__name %}{{ row.subcategory__name }}{% else %}<span class="muted">Sin subcategoría</span>{% endif %}</td>
                <td class="num">{{ row.count }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="center muted">Sin datos de subcategorías.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if type == 'tecnico' and by_tech %}
    <div class="section">
      <div class="table-title">
        <h2>Tickets por técnico</h2>
        <span class="small">Asignaciones y cierres</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Técnico</th>
              <th class="num">Tickets</th>
            </tr>
          </thead>
          <tbody>
            {% for row in by_tech %}
              <tr>
                <td>{{ row.assigned_to__username|default:"Sin asignar" }}</td>
                <td class="num">{{ row.count }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="2" class="center muted">Sin datos disponibles.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if type == 'urgencia' and urgent_tickets %}
    <div class="section">
      <div class="table-title">
        <h2>Tickets urgentes</h2>
        <span class="small">Ordenados del más reciente</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Título</th>
              <th class="center">Estado</th>
              <th class="center">Prioridad</th>
              <th>Asignado a</th>
            </tr>
          </thead>
          <tbody>
            {% for row in urgent_tickets %}
              <tr>
                <td class="small">{{ row.code }}</td>
                <td>{{ row.title }}</td>
                <td class="center"><span class="badge">{{ row.status }}</span></td>
                <td class="center"><span class="badge">{{ row.priority__name|default:"—" }}</span></td>
                <td>{{ row.assigned_to__username|default:"Sin asignar" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="center muted">No se encontraron tickets urgentes.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if type == 'promedio' %}
    <div class="section">
      <h2>Tiempo promedio</h2>
      <p class="muted">{{ avg_hours|default_if_none:"—" }} horas en promedio considerando solo tickets resueltos en el período.</p>
    </div>
  {% endif %}

  {% if type == 'productividad' %}
    <div class="section">
      <h2>Resumen de productividad</h2>
      <div class="table-wrapper">
        <table>
          <tbody>
            <tr><td class="muted">Tickets cerrados</td><td class="num"><strong>{{ productivity_summary.total_closed|default:"0" }}</strong></td></tr>
            <tr><td class="muted">Promedio de resolución</td><td class="num">{{ productivity_summary.avg_hours|default:"—" }} h</td></tr>
            <tr><td class="muted">Técnico con más cierres</td><td>{{ productivity_summary.top_tech|default:"—" }}</td></tr>
            <tr><td class="muted">Promedio más rápido</td><td>{% if productivity_summary.fastest_tech %}{{ productivity_summary.fastest_tech }} · {{ productivity_summary.fastest_avg }} h{% else %}—{% endif %}</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="section">
      <h2>Top técnicos (cerrados)</h2>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Técnico</th><th class="num">Cerrados</th><th class="num">Promedio (h)</th><th class="center">Último cierre</th></tr></thead>
          <tbody>
            {% for row in productivity_rows %}
              <tr>
                <td>{{ row.tech }}</td>
                <td class="num">{{ row.closed }}</td>
                <td class="num">{{ row.avg_hours|default:"—" }}</td>
                <td class="center small">{% if row.last_closed %}{{ row.last_closed|date:"d/m/Y H:i" }}{% else %}<span class="muted">—</span>{% endif %}</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="center muted">Sin técnicos con cierres en el rango filtrado.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  <p class="muted note">Reporte generado automáticamente. Si detectas datos inesperados, revisa los filtros y vuelve a exportar.</p>
</body>
</html>
