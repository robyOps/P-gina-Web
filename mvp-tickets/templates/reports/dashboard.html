{% extends "base.html" %}
{% block title %}Reportes{% endblock %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .heatmap-grid {
      --heatmap-columns: 25;
      display: grid;
      grid-template-columns: repeat(var(--heatmap-columns), minmax(3rem, 1fr));
      gap: 0.35rem;
      min-width: 48rem;
    }

    .heatmap-cell {
      border-radius: 0.75rem;
      padding: 0.45rem;
      text-align: center;
      font-size: 0.75rem;
      line-height: 1.25rem;
      font-weight: 500;
      background-color: rgba(226, 232, 240, 0.6);
      color: #1e293b;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    .heatmap-cell[data-value] {
      cursor: default;
      font-variant-numeric: tabular-nums;
    }

    .heatmap-cell[data-value]:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 20px rgba(30, 64, 175, 0.15);
    }

    .heatmap-header {
      font-weight: 600;
      color: #334155;
      background-color: rgba(148, 163, 184, 0.25);
    }

    .heatmap-row-header {
      text-align: left;
      padding-left: 0.75rem;
    }

    .heatmap-corner {
      background-color: transparent;
    }

    .heatmap-empty {
      color: #94a3b8;
      background-color: rgba(226, 232, 240, 0.5) !important;
    }

    .heatmap-legend-bar {
      background: linear-gradient(
        to right,
        rgba(191, 219, 254, 0.2),
        rgba(96, 165, 250, 0.75),
        rgba(37, 99, 235, 0.95)
      );
      height: 0.75rem;
      border-radius: 9999px;
      flex: 1;
    }
  </style>
{% endblock %}

{% block content %}
<div class="space-y-8">
  <section class="page-hero rounded-3xl border border-indigo-100 bg-gradient-to-br from-indigo-600 via-blue-500 to-sky-400 p-6 text-white shadow">
    <div class="mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="space-y-2">
        <p class="page-hero__meta inline-flex items-center gap-2 rounded-full bg-white/20 px-3 py-1 text-xs font-semibold uppercase tracking-[0.35em]">Analítica</p>
        <h1 class="text-3xl font-bold tracking-tight">Reportes y tendencias</h1>
        <p class="max-w-2xl text-sm text-blue-100">Analiza la operación del helpdesk con filtros dinámicos, visualizaciones pastel y exporta tus resultados cuando lo necesites.</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <a href="{% url 'reports_export_pdf' %}?from={{ from }}&to={{ to }}&type={{ report_type }}&tech={{ tech_selected }}" class="btn inline-flex items-center gap-2 rounded-full bg-white px-5 py-2 text-sm font-semibold text-indigo-700 shadow-lg shadow-indigo-900/20 transition hover:bg-indigo-50">
          <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
        </a>
        <a href="{% url 'reports_export_excel' %}?from={{ from }}&to={{ to }}&type={{ report_type }}&tech={{ tech_selected }}" class="btn inline-flex items-center gap-2 rounded-full border border-white/50 px-5 py-2 text-sm font-semibold text-white/90 transition hover:bg-white/15">
          <i class="bi bi-file-earmark-spreadsheet"></i> Exportar Excel
        </a>
      </div>
    </div>
    <form method="get" class="rounded-2xl border border-white/30 bg-white/95 p-6 shadow-inner backdrop-blur-sm">
      <div class="grid gap-4 text-sm md:grid-cols-5">
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Desde</label>
          <input type="date" name="from" value="{{ from }}" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Hasta</label>
          <input type="date" name="to" value="{{ to }}" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Tipo de reporte</label>
          <select name="type" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="total" {% if report_type == 'total' %}selected{% endif %}>Total</option>
            <option value="categoria" {% if report_type == 'categoria' %}selected{% endif %}>Por categoría</option>
            <option value="promedio" {% if report_type == 'promedio' %}selected{% endif %}>Tiempo promedio</option>
            <option value="tecnico" {% if report_type == 'tecnico' %}selected{% endif %}>Por técnico</option>
            <option value="urgencia" {% if report_type == 'urgencia' %}selected{% endif %}>Urgencia</option>
          </select>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Técnico</label>
          <select name="tech" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="" {% if not tech_selected %}selected{% endif %}>(Todos)</option>
            {% for t in techs %}
            <option value="{{ t.id }}" {% if tech_selected == t.id|stringformat:'s' %}selected{% endif %}>{{ t.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button class="btn inline-flex w-full items-center justify-center gap-2 rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-700" type="submit">
            <i class="bi bi-funnel"></i> Filtrar
          </button>
          <a href="{% url 'reports_dashboard' %}" class="btn inline-flex items-center justify-center gap-2 rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 hover:border-indigo-200 hover:text-indigo-600">
            <i class="bi bi-eraser"></i> Limpiar
          </a>
        </div>
      </div>
    </form>
  </section>

  <section class="grid gap-6 md:grid-cols-3">
    <article class="flex flex-col gap-3 rounded-3xl border border-sky-200 bg-gradient-to-br from-sky-50 via-white to-blue-50 p-6 shadow-sm">
      <div class="text-sm font-semibold uppercase tracking-wide text-sky-600">Tickets totales</div>
      <div class="text-4xl font-bold text-slate-900">{{ total }}</div>
      <div class="mt-1 space-y-1 text-sm text-slate-600">
        {% for k,v in by_status.items %}
          <div class="flex items-center justify-between">
            <span>{{ k }}</span>
            <span class="font-semibold text-slate-800">{{ v }}</span>
          </div>
        {% endfor %}
      </div>
    </article>
    <article class="flex flex-col gap-3 rounded-3xl border border-emerald-200 bg-gradient-to-br from-emerald-50 via-white to-emerald-100 p-6 shadow-sm">
      <div class="text-sm font-semibold uppercase tracking-wide text-emerald-600">Promedio de resolución (hrs)</div>
      <div class="text-4xl font-bold text-slate-900">{{ avg_hours|default:"—" }}</div>
      <p class="text-sm text-slate-600">Tiempo medio desde la apertura hasta la resolución de tickets cerrados.</p>
    </article>
    <article class="flex flex-col gap-3 rounded-3xl border border-amber-200 bg-gradient-to-br from-amber-50 via-white to-amber-100 p-6 shadow-sm">
      <div class="text-sm font-semibold uppercase tracking-wide text-amber-600">Tickets por prioridad</div>
      <ul class="space-y-1 text-sm text-slate-700">
        {% for row in by_priority %}
        <li class="flex items-center justify-between">
          <span>{{ row.priority__name }}</span>
          <span class="font-semibold text-slate-900">{{ row.count }}</span>
        </li>
        {% endfor %}
      </ul>
    </article>
  </section>

  <section class="grid gap-6 lg:grid-cols-2">
    <article class="rounded-3xl border border-sky-100 bg-gradient-to-br from-white via-sky-50 to-blue-50 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Por categoría</h2>
      <p class="text-sm text-slate-500">Volumen de tickets según clasificación funcional.</p>
      <div class="mt-4 h-64"><canvas id="chartCat"></canvas></div>
    </article>
    <article class="rounded-3xl border border-emerald-100 bg-gradient-to-br from-white via-emerald-50 to-emerald-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Por prioridad</h2>
      <p class="text-sm text-slate-500">Distribución según la urgencia declarada.</p>
      <div class="mt-4 h-64"><canvas id="chartPri"></canvas></div>
    </article>
    <article class="rounded-3xl border border-amber-100 bg-gradient-to-br from-white via-amber-50 to-amber-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Por técnico</h2>
      <p class="text-sm text-slate-500">Tickets asignados por responsable.</p>
      <div class="mt-4 h-64"><canvas id="chartTech"></canvas></div>
    </article>
    <article class="rounded-3xl border border-rose-100 bg-gradient-to-br from-white via-rose-50 to-rose-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Horas de resolución</h2>
      <p class="text-sm text-slate-500">Histograma de tiempos empleados en resolver incidencias.</p>
      <div class="mt-4 h-64"><canvas id="chartHist"></canvas></div>
    </article>
    <article class="lg:col-span-2 rounded-3xl border border-indigo-100 bg-gradient-to-br from-white via-indigo-50 to-sky-50 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Categorías más lentas</h2>
      <p class="text-sm text-slate-500">Promedio de horas hasta el cierre por categoría.</p>
      <div class="mt-4 h-64"><canvas id="chartCatSlow"></canvas></div>
    </article>
  </section>

  <section class="rounded-3xl border border-indigo-100 bg-gradient-to-br from-white via-indigo-50 to-blue-50/40 p-6 shadow-sm">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
      <div>
        <h2 class="text-base font-semibold text-slate-900">Mapa de calor por día y hora</h2>
        <p class="text-sm text-slate-500">Identifica los momentos con mayor carga de tickets y ajusta la dotación de soporte.</p>
      </div>
      <form id="heatmapFilters" class="flex flex-wrap items-end gap-3 rounded-2xl border border-indigo-100/80 bg-white/70 p-3 text-sm shadow-sm">
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="heatmap_from">Desde</label>
          <input type="date" id="heatmap_from" name="heatmap_from" value="{{ from }}" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="heatmap_to">Hasta</label>
          <input type="date" id="heatmap_to" name="heatmap_to" value="{{ to }}" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="heatmap_area">Área</label>
          <select id="heatmap_area" name="heatmap_area" class="min-w-[10rem] rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="" {% if not heatmap_area_selected %}selected{% endif %}>(Todas)</option>
            {% for area in areas %}
              <option value="{{ area.id }}" {% if heatmap_area_selected == area.id|stringformat:'s' %}selected{% endif %}>{{ area.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-center gap-2">
          <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-700">
            <i class="bi bi-arrow-repeat"></i> Actualizar
          </button>
          <button type="reset" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 font-semibold text-slate-600 hover:border-indigo-200 hover:text-indigo-600">
            <i class="bi bi-eraser"></i> Limpiar
          </button>
        </div>
      </form>
    </div>
    <div class="mt-6 space-y-4">
      <p id="heatmapStatus" class="text-sm text-slate-500">Cargando mapa de calor…</p>
      <div class="overflow-x-auto">
        <div id="heatmapGrid" class="heatmap-grid" role="grid" aria-live="polite" aria-busy="false"></div>
      </div>
      <div class="flex items-center gap-3 text-xs font-medium text-slate-500">
        <span id="heatmapLegendMin">0</span>
        <div class="heatmap-legend-bar" aria-hidden="true"></div>
        <span id="heatmapLegendMax">0</span>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  {{ chart_cat|json_script:"chart_cat_data" }}
  {{ chart_pri|json_script:"chart_pri_data" }}
  {{ chart_tech|json_script:"chart_tech_data" }}
  {{ chart_hist|json_script:"chart_hist_data" }}
  {{ chart_cat_slow|json_script:"chart_cat_slow_data" }}
  <script>
    const PALETTES = {
      chartCat: ["#0ea5e9", "#38bdf8", "#0284c7", "#7dd3fc", "#0c4a6e"],
      chartPri: ["#059669", "#34d399", "#10b981", "#047857", "#6ee7b7"],
      chartTech: ["#f59e0b", "#f97316", "#fb923c", "#fbbf24", "#facc15"],
      chartHist: ["#ec4899", "#f472b6", "#be185d", "#f9a8d4", "#db2777"],
      chartCatSlow: ["#6366f1", "#4f46e5", "#818cf8", "#4338ca", "#a5b4fc"],
      default: ["#1d4ed8", "#2563eb", "#3b82f6", "#60a5fa", "#93c5fd"],
    };

    function hexToRgba(hex, alpha = 0.85) {
      if (!hex) return `rgba(15, 23, 42, ${alpha})`;
      let sanitized = hex.replace("#", "");
      if (sanitized.length === 3) {
        sanitized = sanitized.split("").map((char) => char + char).join("");
      }
      const intVal = parseInt(sanitized, 16);
      const r = (intVal >> 16) & 255;
      const g = (intVal >> 8) & 255;
      const b = intVal & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function paletteFor(id) {
      return PALETTES[id] || PALETTES.default;
    }

    function withAlpha(color, alpha = 0.75) {
      if (typeof color !== "string") {
        return hexToRgba("#0f172a", alpha);
      }
      if (color.startsWith("#")) {
        return hexToRgba(color, alpha);
      }
      return color;
    }

    function parseData(id) {
      const el = document.getElementById(id);
      if (!el) return { labels: [], data: [] };
      const js = JSON.parse(el.textContent || "{}");
      const labels = Array.isArray(js.labels) ? js.labels : [];
      const data = (Array.isArray(js.data) ? js.data : []).map((value) => Number(value) || 0);
      return { labels, data };
    }

    function buildBar(canvasId, dataset, title, { decimals = 0 } = {}) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return null;
      const ctx = canvas.getContext("2d");
      const max = Math.max(1, ...dataset.data);
      const palette = paletteFor(canvasId);
      const borderColors = dataset.data.map((_, index) => palette[index % palette.length]);
      const backgroundColors = borderColors.map((color) => withAlpha(color, 0.65));

      return new Chart(ctx, {
        type: "bar",
        data: {
          labels: dataset.labels,
          datasets: [
            {
              label: title,
              data: dataset.data,
              backgroundColor: backgroundColors,
              borderColor: borderColors,
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: max <= 3 ? 3 : undefined,
              ticks: { precision: decimals },
              grid: { color: "#e2e8f0" },
            },
            x: {
              ticks: { color: "#475569" },
              grid: { display: false },
            },
          },
        },
      });
    }

    const cat = parseData("chart_cat_data");
    const pri = parseData("chart_pri_data");
    const tech = parseData("chart_tech_data");
    const hist = parseData("chart_hist_data");
    const slow = parseData("chart_cat_slow_data");

    buildBar("chartCat", cat, "Por categoría");
    buildBar("chartPri", pri, "Por prioridad");
    buildBar("chartTech", tech, "Por técnico");
    buildBar("chartHist", hist, "Horas de resolución (histograma)");
    buildBar("chartCatSlow", slow, "Categorías más lentas (hrs)", { decimals: 1 });
  </script>
  <script>
    (function () {
      const form = document.getElementById("heatmapFilters");
      const status = document.getElementById("heatmapStatus");
      const grid = document.getElementById("heatmapGrid");
      const legendMin = document.getElementById("heatmapLegendMin");
      const legendMax = document.getElementById("heatmapLegendMax");

      if (!form || !status || !grid) {
        return;
      }

      function formatHour(hour) {
        const value = Number(hour || 0);
        return `${String(value).padStart(2, "0")}:00`;
      }

      function intensityColor(value, max) {
        if (!value || !max) {
          return "rgba(148, 163, 184, 0.25)";
        }
        const ratio = Math.max(0, Math.min(1, value / max));
        const alpha = 0.18 + 0.72 * Math.pow(ratio, 0.85);
        return `rgba(37, 99, 235, ${alpha.toFixed(3)})`;
      }

      function createCell(text, className) {
        const cell = document.createElement("div");
        cell.className = className;
        cell.textContent = text;
        return cell;
      }

      function createValueCell(dayLabel, hourLabel, value, maxValue) {
        const cell = document.createElement("div");
        const safeValue = Number(value || 0);
        cell.className = "heatmap-cell heatmap-value";
        cell.dataset.value = String(safeValue);
        cell.setAttribute("role", "gridcell");
        cell.setAttribute(
          "aria-label",
          `${dayLabel} a las ${hourLabel}: ${safeValue} ticket${safeValue === 1 ? "" : "s"}`
        );
        if (!safeValue) {
          cell.textContent = "—";
          cell.classList.add("heatmap-empty");
        } else {
          cell.textContent = String(safeValue);
        }

        const color = intensityColor(safeValue, maxValue);
        cell.style.backgroundColor = color;
        if (maxValue > 0) {
          const ratio = safeValue / maxValue;
          if (ratio >= 0.6) {
            cell.style.color = "#f8fafc";
          }
        }
        return cell;
      }

      function renderHeatmap(data) {
        const hours = Array.isArray(data?.hours) ? data.hours : [];
        const weekdays = Array.isArray(data?.weekdays) ? data.weekdays : [];
        const matrix = Array.isArray(data?.matrix) ? data.matrix : [];
        const maxValue = Number(data?.max_value || 0);

        grid.style.setProperty("--heatmap-columns", hours.length + 1);
        grid.innerHTML = "";
        grid.setAttribute("role", "grid");

        const fragment = document.createDocumentFragment();
        const corner = createCell("", "heatmap-cell heatmap-header heatmap-corner");
        corner.setAttribute("role", "columnheader");
        fragment.appendChild(corner);

        hours.forEach((hour) => {
          const header = createCell(formatHour(hour), "heatmap-cell heatmap-header");
          header.setAttribute("role", "columnheader");
          fragment.appendChild(header);
        });

        weekdays.forEach((dayLabel, rowIndex) => {
          const rowHeader = createCell(dayLabel, "heatmap-cell heatmap-header heatmap-row-header");
          rowHeader.setAttribute("role", "rowheader");
          fragment.appendChild(rowHeader);

          hours.forEach((hour, columnIndex) => {
            const value = matrix[rowIndex]?.[columnIndex] ?? 0;
            const cell = createValueCell(dayLabel, formatHour(hour), value, maxValue);
            fragment.appendChild(cell);
          });
        });

        grid.appendChild(fragment);

        legendMin.textContent = "0";
        legendMax.textContent = String(maxValue);

        const total = Number(data?.totals?.overall || 0);
        status.textContent = total
          ? `Total de tickets en el rango: ${total}`
          : "Sin tickets en el rango seleccionado.";
      }

      async function loadHeatmap() {
        const formData = new FormData(form);
        const params = new URLSearchParams();
        const from = formData.get("heatmap_from");
        const to = formData.get("heatmap_to");
        const area = formData.get("heatmap_area");

        if (from) params.set("from", from);
        if (to) params.set("to", to);
        if (area) params.set("area", area);

        const query = params.toString();
        const url = `/api/reports/heatmap/${query ? `?${query}` : ""}`;

        status.textContent = "Cargando mapa de calor…";
        grid.setAttribute("aria-busy", "true");
        grid.innerHTML = "";

        try {
          const response = await fetch(url, { credentials: "same-origin" });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const payload = await response.json();
          renderHeatmap(payload);
        } catch (error) {
          console.error("Heatmap request failed", error);
          status.textContent = "No se pudo cargar el mapa de calor. Intenta nuevamente más tarde.";
        } finally {
          grid.removeAttribute("aria-busy");
        }
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        loadHeatmap();
      });

      form.addEventListener("reset", () => {
        window.requestAnimationFrame(loadHeatmap);
      });

      form.querySelectorAll("input, select").forEach((input) => {
        input.addEventListener("change", () => {
          loadHeatmap();
        });
      });

      loadHeatmap();
    })();
  </script>
{% endblock %}
