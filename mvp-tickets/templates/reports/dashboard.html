{% extends "base.html" %}
{% block title %}Reportes{% endblock %}

{% block head_extra %}
  <style>
    .reports-export-group > a {
      display: inline-flex;
    }
    .reports-hero-actions {
      display: grid;
      gap: 0.75rem;
    }
    .reports-filter-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
    }
    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 16rem;
    }
    .chart-wrapper canvas {
      width: 100% !important;
      height: 100% !important;
    }
    .report-filter-hidden {
      display: none;
    }
    .tech-suggestions,
    .tech-modal__list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.35rem;
    }
    .tech-suggestions { display: grid; }
    .tech-suggestions.is-hidden { display: none; }
    .tech-list-trigger.is-hidden { display: none; }
    .tech-suggestions button,
    .tech-modal__list button {
      text-align: left;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
      color: #0f172a;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
    }
    .tech-suggestions button:hover,
    .tech-suggestions button:focus-visible,
    .tech-modal__list button:hover,
    .tech-modal__list button:focus-visible {
      border-color: #818cf8;
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);
      outline: none;
      transform: translateY(-1px);
    }
    .tech-suggestions__empty,
    .tech-modal__empty {
      font-size: 0.8rem;
      color: #475569;
      padding: 0.35rem 0.5rem;
      border: 1px dashed #e2e8f0;
      border-radius: 0.75rem;
      background: #f8fafc;
    }
    .reports-filters-panel.is-collapsed {
      display: none;
    }
    .tech-filter-group {
      position: relative;
      padding-bottom: 3rem;
    }
    .tech-list-trigger {
      position: absolute;
      right: 0;
      bottom: 0.25rem;
      border: 1px dashed #cbd5e1;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.75rem;
      color: #334155;
      background: #f8fafc;
      transition: border-color 0.15s ease, color 0.15s ease, background-color 0.15s ease, box-shadow 0.15s ease;
    }
    .tech-list-trigger:hover,
    .tech-list-trigger:focus-visible {
      border-color: #818cf8;
      color: #312e81;
      background: #eef2ff;
      outline: none;
      box-shadow: 0 10px 25px rgba(129, 140, 248, 0.18);
    }
    .tech-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.36);
      padding: 1.5rem;
      z-index: 40;
    }
    .tech-modal.is-open {
      display: flex;
    }
    .tech-modal__dialog {
      width: min(520px, 100%);
      background: #ffffff;
      border-radius: 1rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
      padding: 1rem;
      max-height: min(70vh, 540px);
      display: grid;
      gap: 0.75rem;
    }
    .tech-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .tech-modal__close {
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      border-radius: 999px;
      padding: 0.35rem 0.6rem;
      color: #475569;
      transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }
    .tech-modal__close:hover,
    .tech-modal__close:focus-visible {
      background: #eef2ff;
      border-color: #818cf8;
      color: #312e81;
      outline: none;
    }
    @media (max-width: 640px) {
      .reports-export-group {
        width: 100%;
        justify-content: flex-start;
      }
      .reports-export-group > a {
        flex: 1 1 auto;
        justify-content: center;
      }
      .reports-filter-actions {
        flex-direction: column;
        align-items: stretch;
      }
      .reports-filter-actions > * {
        width: 100%;
      }
      .chart-wrapper {
        height: 18rem;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="space-y-8">
  <section class="page-hero rounded-3xl border border-indigo-100 bg-gradient-to-br from-indigo-600 via-blue-500 to-sky-400 p-6 text-white shadow">
    <div class="mb-6 flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
      <div class="space-y-3">
        <p class="page-hero__meta inline-flex items-center gap-2 rounded-full bg-white/20 px-3 py-1 text-xs font-semibold uppercase tracking-[0.35em]">Analítica</p>
        <h1 class="text-3xl font-bold tracking-tight">Reportes y tendencias</h1>
        <p class="max-w-2xl text-sm text-blue-100">Analiza la operación del helpdesk con filtros dinámicos, visualizaciones pastel y exporta tus resultados cuando lo necesites.</p>
        <div class="filters-toggle-wrapper">
          <button
            type="button"
            id="filtersToggle"
            class="btn inline-flex items-center gap-1.5 rounded-full border px-3 py-1.5 text-xs font-semibold shadow-sm transition sm:text-sm {% if has_active_filters %}border-indigo-300 bg-indigo-50 text-indigo-700 hover:border-indigo-400 hover:bg-indigo-100{% else %}border-slate-200 bg-white text-slate-600 hover:border-indigo-200 hover:text-indigo-600{% endif %}"
            data-filter-toggle
            aria-expanded="false"
            data-label-show="Mostrar filtros"
            data-label-hide="Ocultar filtros"
            data-has-active-filters="{{ has_active_filters|yesno:'true,false' }}"
          >
            <i class="bi bi-funnel"></i>
            <span data-filter-label>Mostrar filtros</span>
            {% if has_active_filters %}
              <span class="ml-1 inline-flex h-2 w-2 items-center justify-center rounded-full bg-rose-500"></span>
            {% endif %}
          </button>
        </div>
      </div>
      <div class="reports-hero-actions">
        <div class="reports-export-group flex flex-wrap items-center justify-end gap-3">
          <a href="{% url 'reports_export_pdf' %}{% if export_query %}?{{ export_query }}{% endif %}" class="btn inline-flex items-center gap-2 rounded-full bg-white px-5 py-2 text-sm font-semibold text-indigo-700 shadow-lg shadow-indigo-900/20 transition hover:bg-indigo-50">
            <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
          </a>
          <a href="{% url 'reports_export_excel' %}{% if export_query %}?{{ export_query }}{% endif %}" class="btn inline-flex items-center gap-2 rounded-full border border-white/50 px-5 py-2 text-sm font-semibold text-white/90 transition hover:bg-white/15">
            <i class="bi bi-file-earmark-spreadsheet"></i> Exportar Excel
          </a>
        </div>
      </div>
    </div>
    <form
      method="get"
      id="filtersPanel"
      data-start-open="{{ has_active_filters|yesno:'true,false' }}"
      class="reports-filters-panel rounded-2xl border border-white/30 bg-white/95 p-6 shadow-inner backdrop-blur-sm is-collapsed"
      data-filter-panel
      {% if has_active_filters %}data-open="true"{% endif %}
    >
      <div class="reports-filters-grid grid gap-4 text-sm sm:grid-cols-2 md:grid-cols-6">
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Desde</label>
          <input type="date" name="from" value="{{ from }}" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Hasta</label>
          <input type="date" name="to" value="{{ to }}" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Tipo de reporte</label>
          <select name="type" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="total" {% if report_type == 'total' %}selected{% endif %}>Total</option>
            <option value="categoria" {% if report_type == 'categoria' %}selected{% endif %}>Por categoría</option>
            <option value="promedio" {% if report_type == 'promedio' %}selected{% endif %}>Tiempo promedio</option>
            <option value="tecnico" {% if report_type == 'tecnico' %}selected{% endif %}>Por técnico</option>
            <option value="productividad" {% if report_type == 'productividad' %}selected{% endif %}>Productividad de técnicos</option>
            <option value="urgencia" {% if report_type == 'urgencia' %}selected{% endif %}>Urgencia</option>
          </select>
        </div>
        <div class="flex flex-col gap-1 tech-filter-group {% if report_type != 'tecnico' %}report-filter-hidden{% endif %}" data-report-type="tecnico" id="techFilterGroup">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Técnico</label>
          <input type="hidden" name="tech" id="techHiddenInput" value="{{ tech_selected }}" />
          <input type="text" id="techSearch" value="{{ tech_selected_label }}" autocomplete="off" placeholder="Busca por nombre" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
          <button type="button" id="techListTrigger" class="tech-list-trigger">Lista de técnicos</button>
          <div id="techSuggestions" class="tech-suggestions is-hidden" aria-live="polite"></div>
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">SLA</label>
          <select name="sla" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="" {% if not sla_selected %}selected{% endif %}>(Todos)</option>
            {% for p in priorities %}
            <option value="{{ p.id }}" {% if sla_selected == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }} · {{ p.sla_hours }}h</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex flex-col gap-1 {% if report_type != 'productividad' %}report-filter-hidden{% endif %}" data-report-type="productividad">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Área</label>
          <select name="area" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="" {% if not area_selected %}selected{% endif %}>(Todas)</option>
            {% for area in areas %}
            <option value="{{ area.id }}" {% if area_selected == area.id|stringformat:'s' %}selected{% endif %}>{{ area.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex flex-col gap-1 {% if report_type != 'productividad' %}report-filter-hidden{% endif %}" data-report-type="productividad">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Categoría</label>
          <select name="category" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="" {% if not category_selected %}selected{% endif %}>(Todas)</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}" {% if category_selected == cat.id|stringformat:'s' %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex flex-col gap-1 {% if report_type != 'productividad' %}report-filter-hidden{% endif %}" data-report-type="productividad">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Prioridad</label>
          <select name="priority" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="" {% if not priority_selected %}selected{% endif %}>(Todas)</option>
            {% for pri in priorities %}
            <option value="{{ pri.id }}" {% if priority_selected == pri.id|stringformat:'s' %}selected{% endif %}>{{ pri.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex flex-col gap-1 {% if report_type != 'productividad' %}report-filter-hidden{% endif %}" data-report-type="productividad">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Estado</label>
          <select name="status" class="rounded-xl border border-slate-200 px-3 py-2 text-slate-900 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
            <option value="" {% if not status_selected %}selected{% endif %}>(Todos)</option>
            {% for key,label in status_choices %}
            <option value="{{ key }}" {% if status_selected == key %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="reports-filter-actions md:col-span-2">
          <button class="btn inline-flex w-full items-center justify-center gap-2 rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-700 sm:w-auto" type="submit">
            <i class="bi bi-funnel"></i> Filtrar
          </button>
          <a href="{% url 'reports_dashboard' %}" class="btn inline-flex items-center justify-center gap-2 rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 hover:border-indigo-200 hover:text-indigo-600 sm:w-auto">
            <i class="bi bi-eraser"></i> Limpiar
          </a>
        </div>
      </div>
    </form>
  </section>

  <div class="tech-modal" id="techModal" role="dialog" aria-modal="true" aria-labelledby="techModalTitle">
    <div class="tech-modal__dialog">
      <div class="tech-modal__header">
        <div>
          <h3 id="techModalTitle" class="text-base font-semibold text-slate-900">Lista de técnicos</h3>
          <p class="text-xs text-slate-600">Haz clic en un nombre para rellenar el filtro automáticamente.</p>
        </div>
        <button type="button" class="tech-modal__close" id="techModalClose" aria-label="Cerrar lista de técnicos">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="tech-modal__list" id="techModalList" aria-live="polite"></div>
    </div>
  </div>

  <section class="grid gap-6 md:grid-cols-3">
    <article class="flex flex-col gap-3 rounded-3xl border border-sky-200 bg-gradient-to-br from-sky-50 via-white to-blue-50 p-6 shadow-sm">
      <div class="text-sm font-semibold uppercase tracking-wide text-sky-600">Tickets totales</div>
      <div class="text-4xl font-bold text-slate-900">{{ total }}</div>
      <div class="mt-1 space-y-1 text-sm text-slate-600">
        {% for k,v in by_status.items %}
          <div class="flex items-center justify-between">
            <span>{{ k }}</span>
            <span class="font-semibold text-slate-800">{{ v }}</span>
          </div>
        {% endfor %}
      </div>
    </article>
    <article class="flex flex-col gap-3 rounded-3xl border border-emerald-200 bg-gradient-to-br from-emerald-50 via-white to-emerald-100 p-6 shadow-sm">
      <div class="text-sm font-semibold uppercase tracking-wide text-emerald-600">Promedio de resolución (hrs)</div>
      <div class="text-4xl font-bold text-slate-900">{{ avg_hours|default:"—" }}</div>
      <p class="text-sm text-slate-600">Tiempo medio desde la apertura hasta la resolución de tickets cerrados.</p>
    </article>
    <article class="flex flex-col gap-3 rounded-3xl border border-amber-200 bg-gradient-to-br from-amber-50 via-white to-amber-100 p-6 shadow-sm">
      <div class="text-sm font-semibold uppercase tracking-wide text-amber-600">Tickets por prioridad</div>
      <ul class="space-y-1 text-sm text-slate-700">
        {% for row in by_priority %}
        <li class="flex items-center justify-between">
          <span>{{ row.priority__name }}</span>
          <span class="font-semibold text-slate-900">{{ row.count }}</span>
        </li>
        {% endfor %}
      </ul>
    </article>
  </section>

  {% if report_type == 'productividad' %}
  <section class="grid gap-6 lg:grid-cols-[1.2fr_0.8fr]">
    <article class="rounded-3xl border border-indigo-100 bg-gradient-to-br from-white via-indigo-50 to-sky-50 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">KPIs de productividad</h2>
      <p class="text-sm text-slate-500">Cierres y tiempos promedio considerando el rango y filtros aplicados.</p>
      <dl class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-2xl bg-white px-3 py-2 shadow-sm">
          <dt class="text-[10px] font-semibold uppercase tracking-[0.25em] text-slate-500">Tickets cerrados</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900">{{ productivity_stats.summary.total_closed|default:"0" }}</dd>
        </div>
        <div class="rounded-2xl bg-white px-3 py-2 shadow-sm">
          <dt class="text-[10px] font-semibold uppercase tracking-[0.25em] text-slate-500">Promedio de resolución</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900">{{ productivity_stats.summary.avg_hours|default:"—" }} h</dd>
        </div>
        <div class="rounded-2xl bg-white px-3 py-2 shadow-sm">
          <dt class="text-[10px] font-semibold uppercase tracking-[0.25em] text-slate-500">Mayor cierre</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900">{{ productivity_stats.summary.top_tech|default:"—" }}</dd>
        </div>
        <div class="rounded-2xl bg-white px-3 py-2 shadow-sm">
          <dt class="text-[10px] font-semibold uppercase tracking-[0.25em] text-slate-500">Promedio más rápido</dt>
          <dd class="mt-1 text-xl font-semibold text-emerald-600">{% if productivity_stats.summary.fastest_tech %}{{ productivity_stats.summary.fastest_tech }} · {{ productivity_stats.summary.fastest_avg }} h{% else %}—{% endif %}</dd>
        </div>
      </dl>
    </article>
    <article class="rounded-3xl border border-emerald-100 bg-gradient-to-br from-white via-emerald-50 to-emerald-100/70 p-6 shadow-sm">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h2 class="text-base font-semibold text-slate-900">Top técnicos</h2>
          <p class="text-sm text-slate-500">Ordenados por tickets cerrados en el período.</p>
        </div>
        <span class="rounded-full bg-white px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-emerald-600">Top 10</span>
      </div>
      <div class="-mx-4 mt-4 overflow-x-auto px-4 pb-2 sm:mx-0 sm:px-0">
        <table class="min-w-full divide-y divide-emerald-100 text-sm">
          <thead class="bg-emerald-50 text-xs uppercase tracking-[0.25em] text-emerald-700">
            <tr>
              <th scope="col" class="px-3 py-2 text-left">Técnico</th>
              <th scope="col" class="px-3 py-2 text-right">Cerrados</th>
              <th scope="col" class="px-3 py-2 text-right">Promedio (h)</th>
              <th scope="col" class="px-3 py-2 text-right">Último cierre</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-emerald-50">
            {% for row in productivity_stats.rows|slice:":10" %}
            <tr>
              <td class="px-3 py-2 font-semibold text-slate-900">{{ row.tech }}</td>
              <td class="px-3 py-2 text-right font-semibold text-emerald-700">{{ row.closed }}</td>
              <td class="px-3 py-2 text-right text-slate-700">{{ row.avg_hours|default:"—" }}</td>
              <td class="px-3 py-2 text-right text-slate-600">{% if row.last_closed %}{{ row.last_closed|date:"d/m/Y H:i" }}{% else %}—{% endif %}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="px-3 py-3 text-center text-sm text-slate-500">Sin técnicos cerrando tickets en este rango.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </article>
  </section>
  {% endif %}

  <section class="grid gap-6 lg:grid-cols-2">
    <article class="rounded-3xl border border-indigo-100 bg-gradient-to-br from-white via-indigo-50 to-sky-50 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Panorama de plazos</h2>
      <p class="text-sm text-slate-500">Comparativa general entre tickets al día y vencidos en el período filtrado.</p>
      {% if sla_summary.total_considered %}
      <div class="chart-wrapper mt-4"><canvas id="chartSlaOverview"></canvas></div>
      <dl class="mt-4 grid gap-3 text-xs text-slate-600 sm:grid-cols-3">
        <div class="rounded-xl bg-white px-3 py-2 shadow-sm">
          <dt class="text-[10px] font-semibold uppercase tracking-[0.25em] text-slate-500">Tickets al día</dt>
          <dd class="mt-1 text-lg font-semibold text-slate-900">{{ sla_summary.overall_on_time }}</dd>
        </div>
        <div class="rounded-xl bg-white px-3 py-2 shadow-sm">
          <dt class="text-[10px] font-semibold uppercase tracking-[0.25em] text-slate-500">Vencidos abiertos</dt>
          <dd class="mt-1 text-lg font-semibold text-rose-600">{{ sla_summary.current_overdue }}</dd>
        </div>
        <div class="rounded-xl bg-white px-3 py-2 shadow-sm">
          <dt class="text-[10px] font-semibold uppercase tracking-[0.25em] text-slate-500">Cerrados fuera de plazo</dt>
          <dd class="mt-1 text-lg font-semibold text-rose-600">{{ sla_summary.closed_overdue }}</dd>
        </div>
      </dl>
      {% else %}
      <p class="mt-4 rounded-2xl border border-dashed border-indigo-200 bg-white/70 px-4 py-3 text-sm text-indigo-600">No hay datos suficientes en el rango seleccionado para calcular vencimientos de SLA.</p>
      {% endif %}
    </article>
    <article class="rounded-3xl border border-emerald-100 bg-gradient-to-br from-white via-emerald-50 to-emerald-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Cierres vs SLA</h2>
      <p class="text-sm text-slate-500">Tickets cerrados dentro y fuera del plazo comprometido.</p>
      {% if sla_summary.closed_total %}
      <div class="chart-wrapper mt-4"><canvas id="chartSlaClosed"></canvas></div>
      <ul class="mt-4 grid gap-2 text-xs text-slate-600">
        <li class="flex items-center justify-between rounded-xl bg-white px-3 py-2 shadow-sm"><span>En plazo</span><span class="text-sm font-semibold text-emerald-600">{{ sla_summary.closed_on_time }}</span></li>
        <li class="flex items-center justify-between rounded-xl bg-white px-3 py-2 shadow-sm"><span>Fuera de plazo</span><span class="text-sm font-semibold text-rose-600">{{ sla_summary.closed_overdue }}</span></li>
      </ul>
      {% else %}
      <p class="mt-4 rounded-2xl border border-dashed border-emerald-200 bg-white/70 px-4 py-3 text-sm text-emerald-600">No se registran cierres de tickets en el período analizado.</p>
      {% endif %}
    </article>
  </section>

  <section class="grid gap-6 lg:grid-cols-2">
    <article class="rounded-3xl border border-rose-100 bg-gradient-to-br from-white via-rose-50 to-rose-100/80 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Vencidos por técnico</h2>
      <p class="text-sm text-slate-500">Conteo de incumplimientos según responsable asignado.</p>
      {% if chart_sla_tech.data %}
      <div class="chart-wrapper mt-4"><canvas id="chartSlaTech"></canvas></div>
      {% else %}
      <p class="mt-4 rounded-2xl border border-dashed border-rose-200 bg-white/70 px-4 py-3 text-sm text-rose-600">Sin tickets vencidos asociados a técnicos para este filtro.</p>
      {% endif %}
    </article>
    {% if report_type != 'tecnico' %}
    <article class="rounded-3xl border border-sky-100 bg-gradient-to-br from-white via-sky-50 to-sky-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Vencidos por categoría</h2>
      <p class="text-sm text-slate-500">Áreas funcionales con mayores incumplimientos.</p>
      {% if chart_sla_category.data %}
      <div class="chart-wrapper mt-4"><canvas id="chartSlaCategory"></canvas></div>
      {% else %}
      <p class="mt-4 rounded-2xl border border-dashed border-sky-200 bg-white/70 px-4 py-3 text-sm text-sky-600">No hay categorías con tickets vencidos según el filtro aplicado.</p>
      {% endif %}
    </article>
    <article class="rounded-3xl border border-amber-100 bg-gradient-to-br from-white via-amber-50 to-amber-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Vencidos por subcategoría</h2>
      <p class="text-sm text-slate-500">Detalle específico de subcategorías con mayor retraso.</p>
      {% if chart_sla_subcategory.data %}
      <div class="chart-wrapper mt-4"><canvas id="chartSlaSubcategory"></canvas></div>
      {% else %}
      <p class="mt-4 rounded-2xl border border-dashed border-amber-200 bg-white/70 px-4 py-3 text-sm text-amber-600">Sin subcategorías con vencimientos para los criterios actuales.</p>
      {% endif %}
    </article>
    <article class="rounded-3xl border border-emerald-100 bg-gradient-to-br from-white via-emerald-50 to-emerald-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Vencidos por área</h2>
      <p class="text-sm text-slate-500">Distribución de incumplimientos según áreas organizacionales.</p>
      {% if chart_sla_area.data %}
      <div class="chart-wrapper mt-4"><canvas id="chartSlaArea"></canvas></div>
      {% else %}
      <p class="mt-4 rounded-2xl border border-dashed border-emerald-200 bg-white/70 px-4 py-3 text-sm text-emerald-600">Aún no hay áreas con tickets vencidos en el rango seleccionado.</p>
      {% endif %}
    </article>
    {% endif %}
  </section>

  {% if report_type == 'tecnico' or report_type == 'productividad' %}
  <section class="grid gap-6 lg:grid-cols-2">
    <article class="rounded-3xl border border-amber-100 bg-gradient-to-br from-white via-amber-50 to-amber-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Por técnico</h2>
      <p class="text-sm text-slate-500">Tickets asignados por responsable.</p>
      <div class="chart-wrapper mt-4"><canvas id="chartTech"></canvas></div>
    </article>
    <article class="rounded-3xl border border-rose-100 bg-gradient-to-br from-white via-rose-50 to-rose-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Horas de resolución</h2>
      <p class="text-sm text-slate-500">Histograma de tiempos empleados en resolver incidencias.</p>
      <div class="chart-wrapper mt-4"><canvas id="chartHist"></canvas></div>
    </article>
  </section>
  {% else %}
  <section class="grid gap-6 lg:grid-cols-2">
    <article class="rounded-3xl border border-sky-100 bg-gradient-to-br from-white via-sky-50 to-blue-50 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Por categoría</h2>
      <p class="text-sm text-slate-500">Volumen de tickets según clasificación funcional.</p>
      <div class="chart-wrapper mt-4"><canvas id="chartCat"></canvas></div>
    </article>
    <article class="rounded-3xl border border-emerald-100 bg-gradient-to-br from-white via-emerald-50 to-emerald-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Por prioridad</h2>
      <p class="text-sm text-slate-500">Distribución según la urgencia declarada.</p>
      <div class="chart-wrapper mt-4"><canvas id="chartPri"></canvas></div>
    </article>
    <article class="rounded-3xl border border-amber-100 bg-gradient-to-br from-white via-amber-50 to-amber-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Por técnico</h2>
      <p class="text-sm text-slate-500">Tickets asignados por responsable.</p>
      <div class="chart-wrapper mt-4"><canvas id="chartTech"></canvas></div>
    </article>
    <article class="rounded-3xl border border-rose-100 bg-gradient-to-br from-white via-rose-50 to-rose-100/70 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Horas de resolución</h2>
      <p class="text-sm text-slate-500">Histograma de tiempos empleados en resolver incidencias.</p>
      <div class="chart-wrapper mt-4"><canvas id="chartHist"></canvas></div>
    </article>
    <article class="lg:col-span-2 rounded-3xl border border-indigo-100 bg-gradient-to-br from-white via-indigo-50 to-sky-50 p-6 shadow-sm">
      <h2 class="text-base font-semibold text-slate-900">Categorías más lentas</h2>
      <p class="text-sm text-slate-500">Promedio de horas hasta el cierre por categoría.</p>
      <div class="chart-wrapper mt-4"><canvas id="chartCatSlow"></canvas></div>
    </article>
  </section>
  {% endif %}

</div>
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  {{ chart_cat|json_script:"chart_cat_data" }}
  {{ chart_pri|json_script:"chart_pri_data" }}
  {{ chart_tech|json_script:"chart_tech_data" }}
  {{ chart_hist|json_script:"chart_hist_data" }}
  {{ chart_cat_slow|json_script:"chart_cat_slow_data" }}
  {{ chart_sla_overview|json_script:"chart_sla_overview_data" }}
  {{ chart_sla_closed|json_script:"chart_sla_closed_data" }}
  {{ chart_sla_tech|json_script:"chart_sla_tech_data" }}
  {{ chart_sla_category|json_script:"chart_sla_category_data" }}
  {{ chart_sla_subcategory|json_script:"chart_sla_subcategory_data" }}
  {{ chart_sla_area|json_script:"chart_sla_area_data" }}
  {{ tech_options|json_script:"tech_options_data" }}
  <script>
    const filterTypeSelect = document.querySelector('select[name="type"]');
    const conditionalFilters = document.querySelectorAll('[data-report-type]');
    const techHiddenInput = document.getElementById("techHiddenInput");
    const techSearchInput = document.getElementById("techSearch");
    const techSuggestions = document.getElementById("techSuggestions");
    const techListTrigger = document.getElementById("techListTrigger");
    const techModal = document.getElementById("techModal");
    const techModalList = document.getElementById("techModalList");
    const techModalClose = document.getElementById("techModalClose");
    const filtersPanel = document.getElementById("filtersPanel");
    const filtersToggle = document.getElementById("filtersToggle");
    const techOptions = JSON.parse(document.getElementById("tech_options_data")?.textContent || "[]");

    function filterTechOptions(term = "") {
      const normalized = term.trim().toLowerCase();
      if (!normalized) return techOptions.slice(0, 10);
      return techOptions.filter(
        (item) =>
          item.label.toLowerCase().startsWith(normalized) ||
          item.username.toLowerCase().startsWith(normalized)
      );
    }

    function closeTechSuggestions() {
      if (!techSuggestions) return;
      techSuggestions.innerHTML = "";
      techSuggestions.classList.add("is-hidden");
    }

    function updateTechListVisibility(isTechReport = filterTypeSelect?.value === "tecnico") {
      const hasTechSelected = Boolean(techHiddenInput?.value);
      const shouldHideList = isTechReport && hasTechSelected;

      if (techListTrigger) {
        techListTrigger.classList.toggle("is-hidden", shouldHideList);
        techListTrigger.disabled = !isTechReport;
      }

      if (techSuggestions) {
        const shouldHideSuggestions = !isTechReport || hasTechSelected;
        techSuggestions.classList.toggle("is-hidden", shouldHideSuggestions);
        if (shouldHideSuggestions) {
          closeTechSuggestions();
        } else if (!filtersPanel?.classList.contains("is-collapsed")) {
          renderTechSuggestions(techSearchInput?.value || "");
        }
      }

      if (shouldHideList) {
        closeTechModal();
      }
    }

    function renderTechList(container, term = "", { limit = 8, emptyClass = "tech-suggestions__empty" } = {}) {
      if (!container || techSearchInput?.disabled) return;
      const matches = filterTechOptions(term);
      container.innerHTML = "";
      const subset = matches.slice(0, limit);

      if (!subset.length) {
        const empty = document.createElement("div");
        empty.className = emptyClass;
        empty.textContent = "Sin coincidencias";
        container.appendChild(empty);
        return;
      }

      subset.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = `${item.label} (${item.username})`;
        btn.addEventListener("click", () => {
          if (techSearchInput) techSearchInput.value = item.label;
          if (techHiddenInput) techHiddenInput.value = item.id;
          closeTechSuggestions();
          closeTechModal();
          updateTechListVisibility();
          techSearchInput?.focus();
        });
        container.appendChild(btn);
      });
    }

    function renderTechSuggestions(term = "") {
      if (!techSuggestions || techSearchInput?.disabled) return;
      renderTechList(techSuggestions, term, { limit: 10, emptyClass: "tech-suggestions__empty" });
      techSuggestions.classList.remove("is-hidden");
    }

    function renderTechModal(term = "") {
      if (!techModalList) return;
      renderTechList(techModalList, term, { limit: 30, emptyClass: "tech-modal__empty" });
    }

    function syncTechSelection(value = "") {
      if (!techHiddenInput) return;
      const match = filterTechOptions(value)[0];
      techHiddenInput.value = match ? match.id : "";
      renderTechSuggestions(value);
      if (techModal?.classList.contains("is-open")) {
        renderTechModal(value);
      }
      updateTechListVisibility();
    }

    function commitFirstTechSuggestion() {
      if (!techSearchInput) return false;
      const firstButton = techSuggestions?.querySelector("button");
      if (firstButton) {
        firstButton.click();
        return true;
      }
      const match = filterTechOptions(techSearchInput.value)[0];
      if (match) {
        techHiddenInput.value = match.id;
        techSearchInput.value = match.label;
        closeTechSuggestions();
        updateTechListVisibility();
        return true;
      }
      return false;
    }

    function openTechModal() {
      if (!techModal || techSearchInput?.disabled) return;
      techModal.classList.add("is-open");
      renderTechModal(techSearchInput?.value || "");
    }

    function closeTechModal() {
      if (!techModal) return;
      techModal.classList.remove("is-open");
    }

    function updateFilterVisibility() {
      const activeType = filterTypeSelect?.value;
      conditionalFilters.forEach((node) => {
        const targetType = node.getAttribute("data-report-type");
        const shouldShow = targetType === activeType;
        node.classList.toggle("report-filter-hidden", !shouldShow);
      });
      const isTechReport = activeType === "tecnico";
      if (techSearchInput) {
        techSearchInput.disabled = !isTechReport;
        techSearchInput.classList.toggle("bg-slate-50", !isTechReport);
      }
      if (!isTechReport && techHiddenInput) {
        techHiddenInput.value = "";
        if (techSearchInput) techSearchInput.value = "";
        closeTechSuggestions();
        closeTechModal();
      }
      if (
        isTechReport &&
        techSearchInput &&
        !techHiddenInput?.value &&
        !filtersPanel?.classList.contains("is-collapsed")
      ) {
        renderTechSuggestions(techSearchInput.value || "");
      }
      updateTechListVisibility(isTechReport);
    }

    const hasActiveFilters = filtersToggle?.dataset.hasActiveFilters === "true";
    const labelShow = filtersToggle?.dataset.labelShow || "Mostrar filtros";
    const labelHide = filtersToggle?.dataset.labelHide || "Ocultar filtros";

    function setFiltersOpen(isOpen = false) {
      filtersPanel?.classList.toggle("is-collapsed", !isOpen);
      const label = filtersToggle?.querySelector("[data-filter-label]");
      if (filtersToggle) {
        filtersToggle.setAttribute("aria-expanded", String(isOpen));
        const shouldMarkActive = Boolean(isOpen || hasActiveFilters);
        filtersToggle.classList.toggle("is-active", shouldMarkActive);
      }
      if (label) {
        label.textContent = isOpen ? labelHide : labelShow;
      }
      if (!isOpen) {
        closeTechSuggestions();
      }
    }

    filterTypeSelect?.addEventListener("change", updateFilterVisibility);
    techSearchInput?.addEventListener("input", (event) => {
      syncTechSelection(event.target.value || "");
    });
    techSearchInput?.addEventListener("keydown", (event) => {
      const isEnter = event.key === "Enter";
      const isTech = filterTypeSelect?.value === "tecnico";
      const panelOpen = !filtersPanel?.classList.contains("is-collapsed");
      if (isEnter && isTech && panelOpen) {
        event.preventDefault();
        commitFirstTechSuggestion();
        const form = techSearchInput.form;
        if (form?.requestSubmit) {
          form.requestSubmit();
        } else {
          form?.submit();
        }
      }
    });
    techSearchInput?.addEventListener("focus", () => {
      if (filterTypeSelect?.value === "tecnico" && !filtersPanel?.classList.contains("is-collapsed")) {
        renderTechSuggestions(techSearchInput.value || "");
      }
    });
    techSearchInput?.addEventListener("blur", () => {
      setTimeout(closeTechSuggestions, 120);
    });
    techListTrigger?.addEventListener("click", openTechModal);
    techModalClose?.addEventListener("click", closeTechModal);
    techModal?.addEventListener("click", (event) => {
      const dialog = techModal.querySelector(".tech-modal__dialog");
      if (event.target === techModal && dialog && !dialog.contains(event.target)) {
        closeTechModal();
      }
    });
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeTechModal();
        closeTechSuggestions();
      }
    });
    filtersToggle?.addEventListener("click", () => {
      const nextState = filtersPanel?.classList.contains("is-collapsed");
      setFiltersOpen(nextState);
      if (nextState && filterTypeSelect?.value === "tecnico") {
        renderTechSuggestions(techSearchInput?.value || "");
      }
    });
    filtersPanel?.addEventListener("submit", () => {
      closeTechSuggestions();
      closeTechModal();
    });

    const shouldStartOpen = filtersPanel?.dataset.startOpen === "true";
    setFiltersOpen(shouldStartOpen);
    updateFilterVisibility();
    if (techSearchInput) {
      syncTechSelection(techSearchInput.value || "");
    }

    const PALETTES = {
      chartCat: ["#0ea5e9", "#38bdf8", "#0284c7", "#7dd3fc", "#0c4a6e"],
      chartPri: ["#059669", "#34d399", "#10b981", "#047857", "#6ee7b7"],
      chartTech: ["#f59e0b", "#f97316", "#fb923c", "#fbbf24", "#facc15"],
      chartHist: ["#ec4899", "#f472b6", "#be185d", "#f9a8d4", "#db2777"],
      chartCatSlow: ["#6366f1", "#4f46e5", "#818cf8", "#4338ca", "#a5b4fc"],
      chartSlaOverview: ["#0ea5e9", "#f97316"],
      chartSlaClosed: ["#10b981", "#ef4444"],
      chartSlaTech: ["#fb7185", "#f43f5e", "#be123c", "#fda4af", "#ffccd5"],
      chartSlaCategory: ["#38bdf8", "#0ea5e9", "#0284c7", "#075985", "#7dd3fc"],
      chartSlaSubcategory: ["#facc15", "#eab308", "#ca8a04", "#fde68a", "#fcd34d"],
      chartSlaArea: ["#34d399", "#10b981", "#047857", "#6ee7b7", "#a7f3d0"],
      default: ["#1d4ed8", "#2563eb", "#3b82f6", "#60a5fa", "#93c5fd"],
    };

    function hexToRgba(hex, alpha = 0.85) {
      if (!hex) return `rgba(15, 23, 42, ${alpha})`;
      let sanitized = hex.replace("#", "");
      if (sanitized.length === 3) {
        sanitized = sanitized.split("").map((char) => char + char).join("");
      }
      const intVal = parseInt(sanitized, 16);
      const r = (intVal >> 16) & 255;
      const g = (intVal >> 8) & 255;
      const b = intVal & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function paletteFor(id) {
      return PALETTES[id] || PALETTES.default;
    }

    function withAlpha(color, alpha = 0.75) {
      if (typeof color !== "string") {
        return hexToRgba("#0f172a", alpha);
      }
      if (color.startsWith("#")) {
        return hexToRgba(color, alpha);
      }
      return color;
    }

    function parseData(id) {
      const el = document.getElementById(id);
      if (!el) return { labels: [], data: [] };
      const js = JSON.parse(el.textContent || "{}");
      const labels = Array.isArray(js.labels) ? js.labels : [];
      const data = (Array.isArray(js.data) ? js.data : []).map((value) => Number(value) || 0);
      return { labels, data };
    }

    function buildBar(canvasId, dataset, title, { decimals = 0 } = {}) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return null;
      const ctx = canvas.getContext("2d");
      const max = Math.max(1, ...dataset.data);
      const palette = paletteFor(canvasId);
      const borderColors = dataset.data.map((_, index) => palette[index % palette.length]);
      const backgroundColors = borderColors.map((color) => withAlpha(color, 0.65));

      return new Chart(ctx, {
        type: "bar",
        data: {
          labels: dataset.labels,
          datasets: [
            {
              label: title,
              data: dataset.data,
              backgroundColor: backgroundColors,
              borderColor: borderColors,
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: max <= 3 ? 3 : undefined,
              ticks: { precision: decimals },
              grid: { color: "#e2e8f0" },
            },
            x: {
              ticks: { color: "#475569" },
              grid: { display: false },
            },
          },
        },
      });
    }

    const cat = parseData("chart_cat_data");
    const pri = parseData("chart_pri_data");
    const tech = parseData("chart_tech_data");
    const hist = parseData("chart_hist_data");
    const slow = parseData("chart_cat_slow_data");
    const slaOverview = parseData("chart_sla_overview_data");
    const slaClosed = parseData("chart_sla_closed_data");
    const slaTech = parseData("chart_sla_tech_data");
    const slaCategory = parseData("chart_sla_category_data");
    const slaSubcategory = parseData("chart_sla_subcategory_data");
    const slaArea = parseData("chart_sla_area_data");

    buildBar("chartCat", cat, "Por categoría");
    buildBar("chartPri", pri, "Por prioridad");
    buildBar("chartTech", tech, "Por técnico");
    buildBar("chartHist", hist, "Horas de resolución (histograma)");
    buildBar("chartCatSlow", slow, "Categorías más lentas (hrs)", { decimals: 1 });
    buildBar("chartSlaOverview", slaOverview, "Panorama de plazos");
    buildBar("chartSlaClosed", slaClosed, "Cierres vs SLA");
    buildBar("chartSlaTech", slaTech, "Vencidos por técnico");
    buildBar("chartSlaCategory", slaCategory, "Vencidos por categoría");
    buildBar("chartSlaSubcategory", slaSubcategory, "Vencidos por subcategoría");
    buildBar("chartSlaArea", slaArea, "Vencidos por área");
  </script>
{% endblock %}
