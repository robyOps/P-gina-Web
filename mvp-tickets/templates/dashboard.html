{% extends "base.html" %}
{% load tz %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-3">Dashboard</h1>
<p class="mb-6 text-gray-600">Resumen {{ scope }} de la operación del helpdesk.</p>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <div class="p-4 rounded-lg shadow bg-blue-100">
    <div class="flex items-center">
      <i class="bi bi-ticket-perforated text-3xl text-blue-700 mr-3"></i>
      <div>
        <div class="text-sm text-blue-700">Abiertos</div>
        <div class="text-2xl font-semibold">{{ counts.open }}</div>
      </div>
    </div>
  </div>
  <div class="p-4 rounded-lg shadow bg-yellow-100">
    <div class="flex items-center">
      <i class="bi bi-play-circle text-3xl text-yellow-600 mr-3"></i>
      <div>
        <div class="text-sm text-yellow-600">En progreso</div>
        <div class="text-2xl font-semibold">{{ counts.in_progress }}</div>
      </div>
    </div>
  </div>
  <div class="p-4 rounded-lg shadow bg-green-100">
    <div class="flex items-center">
      <i class="bi bi-check-circle text-3xl text-green-600 mr-3"></i>
      <div>
        <div class="text-sm text-green-600">Resueltos (mes)</div>
        <div class="text-2xl font-semibold">{{ counts.resolved }}</div>
      </div>
    </div>
  </div>
  <div class="p-4 rounded-lg shadow bg-gray-200">
    <div class="flex items-center">
      <i class="bi bi-archive text-3xl text-gray-700 mr-3"></i>
      <div>
        <div class="text-sm text-gray-700">Cerrados (mes)</div>
        <div class="text-2xl font-semibold">{{ counts.closed }}</div>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <div class="bg-white rounded-xl shadow p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Tickets urgentes</h2>
      <span class="text-xs text-gray-500">Ordenados por prioridad de atención</span>
    </div>
    {% if urgent_tickets %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500 uppercase text-xs tracking-wide">
              <th class="pb-2 pr-3">Código</th>
              <th class="pb-2 pr-3">Título</th>
              <th class="pb-2 pr-3">Prioridad</th>
              <th class="pb-2 pr-3">Asignado</th>
              <th class="pb-2">Horas restantes</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            {% for ticket in urgent_tickets %}
            <tr class="hover:bg-gray-50">
              <td class="py-2 pr-3 font-medium text-blue-600">
                <a href="{% url 'ticket_detail' ticket.id %}">{{ ticket.code }}</a>
              </td>
              <td class="py-2 pr-3">{{ ticket.title }}</td>
              <td class="py-2 pr-3">{{ ticket.priority.name }}</td>
              <td class="py-2 pr-3">{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}-{% endif %}</td>
              <td class="py-2">{{ ticket.remaining_hours|floatformat:1 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-sm text-gray-600">No hay tickets urgentes en este momento.</p>
    {% endif %}
  </div>

  <div class="bg-white rounded-xl shadow p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Visualización de datos</h2>
      <div class="inline-flex rounded border border-gray-200 overflow-hidden">
        <button type="button" data-chart-target="status" class="chart-toggle px-3 py-1.5 text-sm bg-blue-600 text-white">Estados</button>
        <button type="button" data-chart-target="failures" class="chart-toggle px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-100">Fallas</button>
      </div>
    </div>
    <div id="chart-status" class="chart-panel flex justify-center">
      <div class="relative h-48 w-48 md:h-56 md:w-56">
        <canvas id="statusChart"></canvas>
      </div>
    </div>
    <div id="chart-failures" class="chart-panel hidden">
      {% if has_failures_data %}
        <canvas id="failuresChart"></canvas>
        <p class="text-xs text-gray-500 mt-2">Datos recopilados desde {{ failures_since|localtime|date:"d/m/Y" }}.</p>
      {% else %}
        <p class="text-sm text-gray-600">No hay registros recientes suficientes para mostrar tendencias de fallas.</p>
      {% endif %}
    </div>
    <p class="text-xs text-gray-500 mt-3">Selecciona la pestaña para alternar entre la distribución de estados y las categorías de fallas más repetidas.</p>
  </div>
</div>

{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusConfig = {{ chart_data|safe }};
    const failuresConfig = {{ failures_chart_data|safe }};
    const hasFailureData = {{ has_failures_data|yesno:"true,false" }};

    const statusCtx = document.getElementById('statusChart');
    const statusChart = new Chart(statusCtx, {
      type: 'pie',
      data: {
        labels: statusConfig.labels,
        datasets: [{
          data: statusConfig.data,
          backgroundColor: ['#bfdbfe', '#fef3c7', '#bbf7d0', '#e5e7eb'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });

    let failuresChart = null;
    const failureColors = ['#2563eb', '#7c3aed', '#f97316', '#059669', '#dc2626', '#0891b2', '#9333ea', '#f59e0b'];

    function ensureFailuresChart() {
      if (!hasFailureData || failuresChart) {
        return;
      }
      const ctx = document.getElementById('failuresChart');
      if (!ctx) {
        return;
      }
      failuresChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: failuresConfig.labels,
          datasets: [{
            label: 'Tickets',
            data: failuresConfig.data,
            backgroundColor: failureColors.slice(0, failuresConfig.data.length)
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    const panels = {
      status: document.getElementById('chart-status'),
      failures: document.getElementById('chart-failures')
    };

    const buttons = document.querySelectorAll('.chart-toggle');

    function setActive(target) {
      buttons.forEach(btn => {
        const isActive = btn.dataset.chartTarget === target;
        btn.classList.toggle('bg-blue-600', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('text-gray-600', !isActive);
      });
      Object.entries(panels).forEach(([key, el]) => {
        if (!el) return;
        el.classList.toggle('hidden', key !== target);
      });
      if (target === 'failures') {
        ensureFailuresChart();
      }
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => setActive(btn.dataset.chartTarget));
    });

    setActive('status');
  });
</script>
{% endblock %}
