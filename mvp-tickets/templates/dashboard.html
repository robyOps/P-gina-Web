{% extends "base.html" %}
{% load tz %}
{% block title %}Dashboard{% endblock %}

{% block head_extra %}
<style>
  .dashboard-shell {
    position: relative;
    overflow: hidden;
    width: 100%;
    transform-origin: top center;
    transition: transform 0.35s ease, box-shadow 0.35s ease, padding 0.35s ease, background 0.35s ease, border-color 0.35s ease;
    border-radius: 2rem;
    background: linear-gradient(135deg, rgba(241, 245, 249, 0.85), rgba(255, 255, 255, 0.95));
    padding: 1.75rem;
    border: 1px solid rgba(148, 163, 184, 0.35);
    margin: 0 auto;
    box-shadow: 0 25px 60px -45px rgba(15, 23, 42, 0.45);
  }
  .dashboard-shell__content {
    position: relative;
    z-index: 20;
  }
  .dashboard-shell__scrim {
    position: absolute;
    inset: 0;
    z-index: 10;
    pointer-events: none;
    background: radial-gradient(circle at top right, rgba(79, 70, 229, 0.18), transparent 45%),
                linear-gradient(180deg, rgba(15, 23, 42, 0.06), transparent 30%, transparent 70%, rgba(15, 23, 42, 0.08));
    opacity: 1;
    transition: opacity 0.35s ease;
  }
  .dashboard-shell.dashboard-shell--compact {
    transform: none;
    max-height: none;
    box-shadow: 0 18px 45px -35px rgba(15, 23, 42, 0.4);
  }
  .dashboard-shell.dashboard-shell--compact .dashboard-shell__scrim {
    opacity: 1;
  }
  .dashboard-shell.dashboard-shell--expanded {
    position: fixed;
    inset: 0;
    z-index: 60;
    transform: none;
    max-height: none;
    padding: 2.5rem clamp(1.5rem, 4vw, 3.5rem);
    background: linear-gradient(135deg, rgba(241, 245, 249, 0.95), rgba(255, 255, 255, 0.98));
    box-shadow: none;
    border-color: transparent;
    border-radius: 0;
    overflow-y: auto;
  }
  .dashboard-shell.dashboard-shell--expanded .dashboard-shell__scrim {
    opacity: 0;
  }
  body.dashboard-expanded {
    overflow: hidden;
  }
  @media (max-width: 1024px) {
    .dashboard-shell {
      transform: none !important;
      max-height: none;
      padding: 0;
      background: transparent;
      box-shadow: none;
      border-color: transparent;
    }
    .dashboard-shell__scrim {
      display: none;
    }
  }
  .dashboard-heatmap {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .dashboard-heatmap__grid {
    --heatmap-hours: 24;
    display: grid;
    gap: 0.4rem;
    overflow-x: auto;
  }
  .dashboard-heatmap__grid-inner {
    display: grid;
    gap: 0.4rem;
    min-width: 48rem;
  }
  .heatmap-cell {
    border-radius: 0.9rem;
    padding: 0.5rem;
    text-align: center;
    font-size: 0.75rem;
    line-height: 1.1rem;
    font-weight: 600;
    background-color: rgba(226, 232, 240, 0.65);
    color: #1e293b;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .heatmap-cell[data-value] {
    font-variant-numeric: tabular-nums;
    cursor: default;
  }
  .heatmap-cell[data-value]:hover {
    transform: scale(1.03);
    box-shadow: 0 10px 28px rgba(37, 99, 235, 0.18);
  }
  .heatmap-header {
    background-color: rgba(148, 163, 184, 0.25);
    color: #334155;
  }
  .heatmap-row-header {
    text-align: left;
    padding-left: 0.9rem;
    white-space: nowrap;
  }
  .heatmap-corner {
    background-color: transparent;
  }
  .heatmap-empty {
    color: #94a3b8;
    background-color: rgba(226, 232, 240, 0.45) !important;
  }
  .dashboard-heatmap__legend {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: #475569;
  }
  .dashboard-heatmap__legend-bar {
    flex: 1;
    height: 0.75rem;
    border-radius: 9999px;
    background: linear-gradient(90deg, rgba(191, 219, 254, 0.2), rgba(96, 165, 250, 0.75), rgba(37, 99, 235, 0.95));
  }
</style>
{% endblock %}

{% block content %}
<div class="relative">
  <div id="dashboardShell" class="dashboard-shell dashboard-shell--compact">
    <div class="dashboard-shell__scrim" aria-hidden="true"></div>
    <div class="dashboard-shell__content">
      <div class="space-y-8 py-5">
        <section class="grid gap-5 sm:grid-cols-2 xl:grid-cols-4">
          <article class="flex flex-col gap-3 rounded-3xl border border-sky-300 bg-sky-200 p-4 shadow-sm sm:p-5">
            <div class="flex items-center justify-between">
              <span class="text-base font-semibold text-sky-900 sm:text-lg">Abiertos</span>
              <span class="flex h-10 w-10 items-center justify-center rounded-full bg-white text-lg text-sky-600 shadow-sm"><i class="bi bi-life-preserver"></i></span>
            </div>
            <p class="text-3xl font-semibold text-slate-900 sm:text-4xl">{{ counts.open }}</p>
          </article>

          <article class="flex flex-col gap-3 rounded-3xl border border-amber-300 bg-amber-200 p-4 shadow-sm sm:p-5">
            <div class="flex items-center justify-between">
              <span class="text-base font-semibold text-amber-900 sm:text-lg">En progreso</span>
              <span class="flex h-10 w-10 items-center justify-center rounded-full bg-white text-lg text-amber-600 shadow-sm"><i class="bi bi-gear-wide-connected"></i></span>
            </div>
            <p class="text-3xl font-semibold text-slate-900 sm:text-4xl">{{ counts.in_progress }}</p>
          </article>

          <article class="flex flex-col gap-3 rounded-3xl border border-emerald-300 bg-emerald-200 p-4 shadow-sm sm:p-5">
            <div class="flex items-center justify-between">
              <span class="text-base font-semibold text-emerald-900 sm:text-lg">Resueltos (mes)</span>
              <span class="flex h-10 w-10 items-center justify-center rounded-full bg-white text-lg text-emerald-600 shadow-sm"><i class="bi bi-check-circle"></i></span>
            </div>
            <p class="text-3xl font-semibold text-slate-900 sm:text-4xl">{{ counts.resolved }}</p>
          </article>

          <article class="flex flex-col gap-3 rounded-3xl border border-rose-300 bg-rose-200 p-4 shadow-sm sm:p-5">
            <div class="flex items-center justify-between">
              <span class="text-base font-semibold text-rose-900 sm:text-lg">Cerrados (mes)</span>
              <span class="flex h-10 w-10 items-center justify-center rounded-full bg-white text-lg text-rose-600 shadow-sm"><i class="bi bi-shield-lock"></i></span>
            </div>
            <p class="text-3xl font-semibold text-slate-900 sm:text-4xl">{{ counts.closed }}</p>
          </article>
        </section>

        <section class="grid gap-5 lg:grid-cols-[1.05fr_1fr]">
          <article class="rounded-3xl border border-rose-100 bg-white p-6 shadow-sm">
            <div class="flex flex-col gap-3">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div>
                  <h2 class="text-2xl font-semibold text-slate-900">Tickets urgentes</h2>
                  <p class="text-sm text-slate-600">Atiende incidentes críticos con un vistazo al tiempo restante y responsables.</p>
                </div>
                <span class="inline-flex items-center gap-2 rounded-full bg-rose-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-rose-500"><i class="bi bi-lightning-charge"></i> Prioridad</span>
              </div>
              {% if urgent_tickets %}
              <ul class="space-y-3" role="list">
                {% for ticket in urgent_tickets %}
                <li class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm transition hover:border-slate-300">
                  <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
                    <a href="{% url 'ticket_detail' ticket.id %}" class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-700 transition hover:bg-slate-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400" aria-label="Abrir ticket {{ ticket.code }}">
                      <i class="bi bi-hash"></i>
                      {{ ticket.code }}
                    </a>
                    <span class="inline-flex items-center gap-2 rounded-full bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-600"><i class="bi bi-exclamation-triangle-fill"></i> {{ ticket.priority.name }}</span>
                  </div>
                  <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <p class="text-base font-semibold text-slate-900">{{ ticket.title }}</p>
                    <div class="flex items-center gap-3 text-sm text-slate-600">
                      <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1"><i class="bi bi-person-circle"></i>{{ ticket.assigned_to.username|default:"-" }}</span>
                      <span class="inline-flex items-center gap-2 rounded-full bg-amber-100 px-3 py-1 text-amber-700 font-semibold"><i class="bi bi-hourglass-split"></i> {{ ticket.remaining_hours|floatformat:1 }} h</span>
                    </div>
                  </div>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <div class="flex flex-col items-center justify-center gap-3 rounded-2xl border border-emerald-100 bg-emerald-50/70 p-8 text-center text-sm text-emerald-600">
                <i class="bi bi-emoji-smile text-3xl"></i>
                <p class="max-w-md text-base">No hay tickets urgentes en este momento. Tu equipo mantiene el control absoluto.</p>
              </div>
              {% endif %}
            </div>
          </article>

          <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <div class="flex flex-col gap-3">
              <div>
                <h2 class="text-2xl font-semibold text-slate-900">Distribución del mes en curso</h2>
                <p class="text-sm text-slate-600">Tickets creados entre {{ current_month_range.start|localtime|date:"d/m/Y" }} y {{ current_month_range.end|localtime|date:"d/m/Y" }}.</p>
              </div>
              <div class="mx-auto mt-3 h-80 w-full max-w-2xl">
                <canvas id="statusChart" aria-label="Gráfico circular de estado de tickets"></canvas>
              </div>
              <div id="statusFilters" class="mt-5 flex flex-wrap gap-3">
                <label class="status-chip flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-sky-200 hover:bg-sky-50" data-index="0">
                  <input type="checkbox" class="status-toggle sr-only" data-index="0" checked>
                  <span class="flex items-center gap-2">
                    <span class="inline-flex h-2.5 w-2.5 rounded-full" style="background-color: #bae6fd"></span>
                    Abiertos
                  </span>
                  <span class="ml-2 text-xs font-semibold text-slate-400">{{ counts.open }}</span>
                </label>
                <label class="status-chip flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-sky-200 hover:bg-sky-50" data-index="1">
                  <input type="checkbox" class="status-toggle sr-only" data-index="1" checked>
                  <span class="flex items-center gap-2">
                    <span class="inline-flex h-2.5 w-2.5 rounded-full" style="background-color: #fde68a"></span>
                    En progreso
                  </span>
                  <span class="ml-2 text-xs font-semibold text-slate-400">{{ counts.in_progress }}</span>
                </label>
                <label class="status-chip flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-sky-200 hover:bg-sky-50" data-index="2">
                  <input type="checkbox" class="status-toggle sr-only" data-index="2" checked>
                  <span class="flex items-center gap-2">
                    <span class="inline-flex h-2.5 w-2.5 rounded-full" style="background-color: #a7f3d0"></span>
                    Resueltos (mes)
                  </span>
                  <span class="ml-2 text-xs font-semibold text-slate-400">{{ counts.resolved }}</span>
                </label>
                <label class="status-chip flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-sky-200 hover:bg-sky-50" data-index="3">
                  <input type="checkbox" class="status-toggle sr-only" data-index="3" checked>
                  <span class="flex items-center gap-2">
                    <span class="inline-flex h-2.5 w-2.5 rounded-full" style="background-color: #fecdd3"></span>
                    Cerrados (mes)
                  </span>
                  <span class="ml-2 text-xs font-semibold text-slate-400">{{ counts.closed }}</span>
                </label>
              </div>
              <p class="text-xs text-slate-500">Desmarca los estados que prefieras ocultar del gráfico circular.</p>
            </div>
          </article>
        </section>

        <section id="tendencias" class="grid gap-5 xl:grid-cols-[2fr_1fr]">
          <article class="rounded-3xl border border-sky-100 bg-white p-6 shadow-sm">
            <div class="flex flex-col gap-3">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div>
                  <h2 class="text-2xl font-semibold text-slate-900">Tendencias de fallas por categoría</h2>
                  <p class="text-sm text-slate-600">Detecta patrones y dimensiona el impacto de cada categoría durante el mes actual.</p>
                </div>
                {% if has_failures_data %}
                <span class="inline-flex items-center gap-2 rounded-full bg-sky-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-sky-600"><i class="bi bi-clock-history"></i> Mes en curso · {{ current_month_range.start|localtime|date:"d/m" }}-{{ current_month_range.end|localtime|date:"d/m" }}</span>
                {% endif %}
              </div>

              {% if has_failures_data %}
              <div class="relative rounded-[1.75rem] border border-sky-100 bg-gradient-to-br from-sky-50 via-white to-emerald-50 p-5 shadow-inner">
                <div class="relative h-72">
                  <canvas id="failuresChart" aria-label="Gráfico de barras con tendencias de fallas"></canvas>
                </div>
              </div>
              {% else %}
              <div class="flex flex-col items-center justify-center gap-3 rounded-2xl border border-sky-100 bg-sky-50/70 p-8 text-center text-sm text-sky-600">
                <i class="bi bi-info-circle text-3xl"></i>
                <p class="max-w-md text-base">No hay registros recientes suficientes para mostrar tendencias de fallas. Mantén la monitorización para descubrir patrones emergentes.</p>
              </div>
              {% endif %}
            </div>
          </article>

          <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
            <div class="flex h-full flex-col gap-3">
              <div>
                <h3 class="text-lg font-semibold text-slate-900">Fallas más comunes</h3>
                <p class="text-sm text-slate-600">Top 15 categorías con mayor volumen reportado durante el mes en curso.</p>
              </div>
              {% if failure_breakdown %}
              <ul class="space-y-3 overflow-y-auto pr-2" role="list">
                {% for failure in failure_breakdown %}
                <li class="space-y-2 rounded-2xl border border-slate-200 bg-slate-50 p-3.5 shadow-sm">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="flex h-10 w-10 items-center justify-center rounded-full font-semibold text-slate-700" style="background: linear-gradient(135deg, {{ failure.color }}33, {{ failure.color }}55);">{{ forloop.counter }}</span>
                      <span class="text-sm font-semibold text-slate-900">{{ failure.label }}</span>
                    </div>
                    <span class="text-sm font-semibold text-slate-600">{{ failure.total }}</span>
                  </div>
                  <div class="h-2 w-full overflow-hidden rounded-full bg-white">
                    <div class="h-full rounded-full" style="background: linear-gradient(90deg, {{ failure.color }}66, {{ failure.color }}aa); width: {{ failure.percentage }}%;"></div>
                  </div>
                </li>
                {% endfor %}
              </ul>
              {% else %}
              <div class="flex flex-col items-center justify-center gap-3 rounded-2xl border border-slate-200 bg-slate-50/80 p-8 text-center text-sm text-slate-600">
                <i class="bi bi-clipboard2-check text-3xl text-slate-500"></i>
                <p class="max-w-xs text-base">Aún no hay suficiente información para crear un ranking de fallas frecuentes.</p>
              </div>
              {% endif %}
            </div>
          </article>
        </section>

        <section class="grid gap-5 xl:grid-cols-[1.1fr_0.95fr]">
          <article class="rounded-3xl border border-emerald-100 bg-white p-6 shadow-sm">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-2xl font-semibold text-slate-900">Top subcategorías del mes</h2>
                <p class="text-sm text-slate-600">Etiquetas confirmadas que concentran la mayor cantidad de tickets creados en el mes actual.</p>
              </div>
              <span class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-emerald-600"><i class="bi bi-calendar3"></i> Mes en curso</span>
            </div>
            {% if top_subcategories %}
            <ol class="mt-4 space-y-3" role="list">
              {% for item in top_subcategories %}
              <li class="space-y-2 rounded-2xl border border-emerald-100 bg-emerald-50/60 p-4 shadow-inner">
                <div class="flex items-center justify-between text-sm font-semibold text-slate-700">
                  <div class="flex items-center gap-3">
                    <span class="flex h-8 w-8 items-center justify-center rounded-full bg-white text-emerald-600 shadow">{{ forloop.counter }}</span>
                    <span class="text-base text-slate-900">{{ item.name }}</span>
                  </div>
                  <span class="text-sm text-emerald-600">{{ item.total }} tickets</span>
                </div>
                <div class="relative h-2.5 w-full overflow-hidden rounded-full bg-white/70">
                  <div class="absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-emerald-400 to-sky-400" style="width: {{ item.percentage }}%;"></div>
                </div>
                <p class="text-xs text-emerald-700">{{ item.percentage }}% del total etiquetado</p>
              </li>
              {% endfor %}
            </ol>
            {% else %}
            <div class="mt-6 flex flex-col items-center justify-center gap-3 rounded-2xl border border-emerald-100 bg-emerald-50/60 p-8 text-center text-sm text-emerald-600">
              <i class="bi bi-tags text-3xl"></i>
              <p class="max-w-sm text-base">Aún no hay suficientes etiquetas confirmadas en los últimos 30 días para construir un ranking.</p>
            </div>
            {% endif %}
          </article>

          <article class="rounded-3xl border border-rose-100 bg-white p-6 shadow-sm">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-2xl font-semibold text-slate-900">Alertas recientes</h2>
                <p class="text-sm text-slate-600">Tickets que requieren atención por riesgo o incumplimiento de SLA.</p>
              </div>
              <span class="inline-flex items-center gap-2 rounded-full bg-rose-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-rose-500"><i class="bi bi-exclamation-octagon"></i> {{ alerts_panel.summary.breaches }} incumplidos · {{ alerts_panel.summary.warnings }} en riesgo</span>
            </div>
            {% if alerts_panel.items %}
            <ul class="mt-4 space-y-3" role="list">
              {% for alert in alerts_panel.items %}
              <li class="space-y-2 rounded-2xl border border-rose-100 bg-rose-50/60 p-4 shadow-inner">
                <div class="flex flex-wrap items-center justify-between gap-2 text-sm">
                  <div class="flex items-center gap-2">
                    <a href="{% url 'ticket_detail' alert.id %}" class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 font-semibold text-rose-600 shadow" aria-label="Abrir ticket {{ alert.code }}">
                      <i class="bi bi-hash"></i> {{ alert.code }}
                    </a>
                    <span class="text-sm font-semibold text-slate-800">{{ alert.title }}</span>
                  </div>
                  <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold {% if alert.severity == 'breach' %}bg-rose-500 text-white{% else %}bg-amber-100 text-amber-700{% endif %}">
                    {% if alert.severity == 'breach' %}<i class="bi bi-x-octagon"></i> Vencido{% else %}<i class="bi bi-hourglass-split"></i> En riesgo{% endif %}
                  </span>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-xs text-slate-600">
                  <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1"><i class="bi bi-calendar-event"></i>Vence {{ alert.due_at|localtime|date:"d/m" }} a las {{ alert.due_at|localtime|time:"H:i" }}</span>
                  <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1"><i class="bi bi-clock-history"></i>{{ alert.remaining_hours|floatformat:1 }}h restantes</span>
                  {% if alert.assigned_to %}
                  <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1"><i class="bi bi-person-circle"></i>{{ alert.assigned_to }}</span>
                  {% endif %}
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="mt-6 flex flex-col items-center justify-center gap-3 rounded-2xl border border-rose-100 bg-rose-50/60 p-8 text-center text-sm text-rose-600">
              <i class="bi bi-shield-check text-3xl"></i>
              <p class="max-w-sm text-base">No hay alertas activas. Mantén el monitoreo para anticipar desviaciones de SLA.</p>
            </div>
            {% endif %}
          </article>
        </section>

        <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 id="dashboardHeatmapTitle" class="text-2xl font-semibold text-slate-900">Mapa de calor del mes</h2>
              <p class="text-sm text-slate-600">Distribución de tickets creados por día y hora durante el período actual.</p>
            </div>
            <div class="flex flex-col items-start gap-1 text-xs font-semibold uppercase tracking-[0.25em] text-slate-500 sm:items-end">
              <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-[11px] font-semibold text-slate-600"><i class="bi bi-graph-up"></i> Datos en tiempo local</span>
              <a href="{% url 'reports_dashboard' %}" class="inline-flex items-center gap-2 text-[11px] font-semibold text-indigo-500 hover:text-indigo-600">
                <i class="bi bi-arrow-up-right"></i> Ver analítica completa
              </a>
            </div>
          </div>

          <div class="dashboard-heatmap mt-6">
            <p id="dashboardHeatmapStatus" class="text-sm text-slate-500">Cargando mapa de calor…</p>
            <div class="dashboard-heatmap__grid" role="group" aria-labelledby="dashboardHeatmapTitle">
              <div id="dashboardHeatmapGrid" class="dashboard-heatmap__grid-inner" role="grid" aria-live="polite" aria-busy="true"></div>
            </div>
            <div class="dashboard-heatmap__legend" aria-hidden="true">
              <span id="dashboardHeatmapLegendMin">0</span>
              <div class="dashboard-heatmap__legend-bar"></div>
              <span id="dashboardHeatmapLegendMax">0</span>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusConfig = {{ chart_data|safe }};
    const failuresConfig = {{ failures_chart_data|safe }};
    const hasFailureData = {{ has_failures_data|yesno:"true,false" }};

    const heatmapStatus = document.getElementById('dashboardHeatmapStatus');
    const heatmapGrid = document.getElementById('dashboardHeatmapGrid');
    const heatmapLegendMin = document.getElementById('dashboardHeatmapLegendMin');
    const heatmapLegendMax = document.getElementById('dashboardHeatmapLegendMax');

    if (heatmapStatus && heatmapGrid && heatmapLegendMin && heatmapLegendMax) {
      const formatHour = (hour) => {
        const value = Number(hour || 0);
        return `${String(value).padStart(2, '0')}:00`;
      };

      const intensityColor = (value, max) => {
        if (!value || !max) {
          return 'rgba(148, 163, 184, 0.25)';
        }
        const ratio = Math.max(0, Math.min(1, value / max));
        const alpha = 0.18 + 0.72 * Math.pow(ratio, 0.9);
        return `rgba(37, 99, 235, ${alpha.toFixed(3)})`;
      };

      const createCell = (text, className) => {
        const cell = document.createElement('div');
        cell.className = className;
        cell.textContent = text;
        return cell;
      };

      const createValueCell = (dayLabel, hourLabel, value, maxValue) => {
        const safeValue = Number(value || 0);
        const cell = document.createElement('div');
        cell.className = 'heatmap-cell heatmap-value';
        cell.dataset.value = String(safeValue);
        cell.setAttribute('role', 'gridcell');
        cell.setAttribute('aria-label', `${dayLabel} a las ${hourLabel}: ${safeValue} ticket${safeValue === 1 ? '' : 's'}`);
        if (!safeValue) {
          cell.textContent = '—';
          cell.classList.add('heatmap-empty');
        } else {
          cell.textContent = String(safeValue);
        }

        const color = intensityColor(safeValue, maxValue);
        cell.style.backgroundColor = color;
        if (maxValue > 0 && safeValue / maxValue >= 0.6) {
          cell.style.color = '#f8fafc';
        }

        return cell;
      };

      const renderHeatmap = (data) => {
        const hours = Array.isArray(data?.hours) ? data.hours : [];
        const weekdays = Array.isArray(data?.weekdays) ? data.weekdays : [];
        const matrix = Array.isArray(data?.matrix) ? data.matrix : [];
        const maxValue = Number(data?.max_value || 0);

        const columnTemplate = hours.length
          ? `minmax(7rem, 1.1fr) repeat(${hours.length}, minmax(3.25rem, 1fr))`
          : 'minmax(7rem, 1fr)';
        heatmapGrid.style.gridTemplateColumns = columnTemplate;

        heatmapGrid.innerHTML = '';

        if (!hours.length || !weekdays.length) {
          const empty = document.createElement('div');
          empty.className = 'heatmap-cell heatmap-empty';
          empty.textContent = 'Sin datos en el rango seleccionado.';
          empty.style.gridColumn = `span ${Math.max(1, hours.length + 1)}`;
          heatmapGrid.appendChild(empty);
          heatmapStatus.textContent = 'Sin tickets en el rango seleccionado.';
          heatmapLegendMin.textContent = '0';
          heatmapLegendMax.textContent = '0';
          heatmapGrid.setAttribute('aria-busy', 'false');
          return;
        }

        const fragment = document.createDocumentFragment();
        const corner = createCell('', 'heatmap-cell heatmap-header heatmap-corner');
        corner.setAttribute('role', 'columnheader');
        fragment.appendChild(corner);

        hours.forEach((hour) => {
          const header = createCell(formatHour(hour), 'heatmap-cell heatmap-header');
          header.setAttribute('role', 'columnheader');
          fragment.appendChild(header);
        });

        weekdays.forEach((dayLabel, rowIndex) => {
          const rowHeader = createCell(dayLabel, 'heatmap-cell heatmap-header heatmap-row-header');
          rowHeader.setAttribute('role', 'rowheader');
          fragment.appendChild(rowHeader);

          hours.forEach((hour, columnIndex) => {
            const value = matrix[rowIndex]?.[columnIndex] ?? 0;
            fragment.appendChild(createValueCell(dayLabel, formatHour(hour), value, maxValue));
          });
        });

        heatmapGrid.appendChild(fragment);

        const total = Number(data?.totals?.overall || 0);
        heatmapStatus.textContent = total
          ? `Total de tickets en el período: ${total}`
          : 'Sin tickets en el rango seleccionado.';
        heatmapLegendMin.textContent = '0';
        heatmapLegendMax.textContent = String(maxValue);
        heatmapGrid.setAttribute('aria-busy', 'false');
      };

      const loadHeatmap = async () => {
        heatmapStatus.textContent = 'Cargando mapa de calor…';
        heatmapGrid.setAttribute('aria-busy', 'true');
        heatmapGrid.innerHTML = '';

        try {
          const response = await fetch('/api/reports/heatmap/', { credentials: 'same-origin' });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const payload = await response.json();
          renderHeatmap(payload);
        } catch (error) {
          console.error('No se pudo cargar el mapa de calor', error);
          heatmapStatus.textContent = 'No se pudo cargar el mapa de calor. Intenta nuevamente más tarde.';
          heatmapLegendMin.textContent = '0';
          heatmapLegendMax.textContent = '0';
          const fallback = document.createElement('div');
          fallback.className = 'heatmap-cell heatmap-empty';
          fallback.textContent = 'Error al cargar datos.';
          heatmapGrid.appendChild(fallback);
          heatmapGrid.setAttribute('aria-busy', 'false');
        }
      };

      loadHeatmap();
    }

    const statusCanvas = document.getElementById('statusChart');
    let statusChart;

    if (statusCanvas) {
      const statusCtx = statusCanvas.getContext('2d');
      const statusPalette = ['#bae6fd', '#fde68a', '#a7f3d0', '#fecdd3'];

      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: statusConfig.labels,
          datasets: [{
            data: statusConfig.data,
            backgroundColor: statusPalette,
            hoverBackgroundColor: statusPalette.map(color => color),
            borderColor: '#f8fafc',
            borderWidth: 3,
            hoverOffset: 10,
            cutout: '0%',
            spacing: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 16,
                color: '#475569',
                font: {
                  size: 14,
                  family: '"Inter", ui-sans-serif, system-ui'
                }
              }
            },
            tooltip: {
              backgroundColor: '#0f172acc',
              titleColor: '#f8fafc',
              bodyColor: '#f1f5f9',
              padding: 12,
              cornerRadius: 12,
              displayColors: false,
              callbacks: {
                label: (context) => `${context.label}: ${context.parsed}`
              }
            }
          }
        }
      });

      const statusToggles = document.querySelectorAll('.status-toggle');
      statusToggles.forEach((toggle) => {
        toggle.addEventListener('change', () => {
          const index = Number(toggle.dataset.index);
          if (Number.isNaN(index) || !statusChart) {
            return;
          }

          const isVisible = statusChart.getDataVisibility(index);
          if (toggle.checked && !isVisible) {
            statusChart.toggleDataVisibility(index);
          } else if (!toggle.checked && isVisible) {
            statusChart.toggleDataVisibility(index);
          }

          const container = toggle.closest('.status-chip');
          if (container) {
            container.classList.toggle('opacity-60', !toggle.checked);
            container.classList.toggle('border-slate-300', !toggle.checked);
          }

          statusChart.update();
        });
      });
    }

    if (hasFailureData) {
      const failureCanvas = document.getElementById('failuresChart');
      if (failureCanvas) {
        const failureCtx = failureCanvas.getContext('2d');
        const failureColors = Array.isArray(failuresConfig.colors) && failuresConfig.colors.length
          ? failuresConfig.colors
          : ['#2563eb'];

        new Chart(failureCtx, {
          type: 'bar',
          data: {
            labels: failuresConfig.labels,
            datasets: [{
              label: 'Tickets',
              data: failuresConfig.data,
              backgroundColor: failureColors,
              borderColor: failureColors,
              borderWidth: 2,
              borderRadius: 14,
              borderSkipped: false,
              hoverBackgroundColor: failureColors,
              maxBarThickness: 36
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#0f172acc',
                titleColor: '#f8fafc',
                bodyColor: '#f1f5f9',
                padding: 12,
                cornerRadius: 12,
                callbacks: {
                  label: (context) => `Tickets: ${context.parsed.y}`
                }
              }
            },
            scales: {
              x: {
                grid: {
                  color: 'rgba(148, 163, 184, 0.12)'
                },
                ticks: {
                  color: '#475569',
                  font: {
                    size: 12,
                    family: '"Inter", ui-sans-serif, system-ui'
                  }
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(148, 163, 184, 0.1)'
                },
                ticks: {
                  color: '#475569',
                  font: {
                    size: 12,
                    family: '"Inter", ui-sans-serif, system-ui'
                  }
                }
              }
            }
          }
        });
      }
    }
  });
</script>
{% endblock %}
