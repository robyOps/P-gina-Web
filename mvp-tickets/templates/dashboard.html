{% extends "base.html" %}
{% load tz %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-10">
  <section class="grid gap-6 lg:grid-cols-[1.4fr_1fr]">
    <article class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
      <div class="flex flex-col gap-4">
        <span class="inline-flex items-center gap-2 text-sm font-medium text-slate-500">
          <i class="bi bi-speedometer"></i>
          Panel principal
        </span>
        <h1 class="text-3xl md:text-4xl font-semibold text-slate-900 tracking-tight">Dashboard</h1>
        <p class="text-base text-slate-600 max-w-2xl">Un vistazo {{ scope }} a la salud del helpdesk y al pulso de las solicitudes de soporte. Todo en un solo lugar, sin distracciones.</p>
        <div class="flex flex-wrap items-center gap-3 text-sm text-slate-500">
          <div class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
            <i class="bi bi-circle-fill text-[10px] text-sky-400"></i>
            Seguimiento activo
          </div>
          <div class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
            <i class="bi bi-arrow-repeat"></i>
            Actualización en tiempo real
          </div>
        </div>
      </div>
    </article>
    <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm flex flex-col justify-between">
      <div>
        <h2 class="text-lg font-semibold text-slate-800">Resumen rápido</h2>
        <p class="mt-1 text-sm text-slate-500">Indicadores clave de tus operaciones hoy.</p>
      </div>
      <dl class="mt-6 grid grid-cols-2 gap-4 text-sm text-slate-600">
        <div>
          <dt class="text-slate-400">Tickets abiertos</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900">{{ counts.open }}</dd>
        </div>
        <div>
          <dt class="text-slate-400">En progreso</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900">{{ counts.in_progress }}</dd>
        </div>
        <div>
          <dt class="text-slate-400">Resueltos</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900">{{ counts.resolved }}</dd>
        </div>
        <div>
          <dt class="text-slate-400">Cerrados</dt>
          <dd class="mt-1 text-2xl font-semibold text-slate-900">{{ counts.closed }}</dd>
        </div>
      </dl>
    </article>
  </section>

  <section class="grid gap-6 lg:grid-cols-[1.3fr_1fr]">
    <article class="rounded-3xl border border-slate-200 bg-white p-6 md:p-8 shadow-sm">
      <div class="flex flex-col gap-6">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
          <div>
            <h2 class="text-2xl font-semibold text-slate-900">Estado de los tickets</h2>
            <p class="mt-1 text-sm text-slate-500">Distribución general por estado y evolución diaria.</p>
          </div>
          <span class="inline-flex items-center gap-2 rounded-full bg-sky-50 px-4 py-1 text-xs font-medium text-sky-600">
            <i class="bi bi-activity text-sm"></i>
            Datos en vivo
          </span>
        </div>
        <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
          <article class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
            <span class="text-xs uppercase tracking-wide text-slate-400">Abiertos</span>
            <p class="mt-3 text-3xl font-semibold text-slate-800">{{ counts.open }}</p>
          </article>
          <article class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
            <span class="text-xs uppercase tracking-wide text-slate-400">En progreso</span>
            <p class="mt-3 text-3xl font-semibold text-slate-800">{{ counts.in_progress }}</p>
          </article>
          <article class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
            <span class="text-xs uppercase tracking-wide text-slate-400">Resueltos</span>
            <p class="mt-3 text-3xl font-semibold text-slate-800">{{ counts.resolved }}</p>
          </article>
          <article class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
            <span class="text-xs uppercase tracking-wide text-slate-400">Cerrados</span>
            <p class="mt-3 text-3xl font-semibold text-slate-800">{{ counts.closed }}</p>
          </article>
        </div>
      </div>
    </article>
    <article class="rounded-3xl border border-slate-200 bg-white p-6 md:p-8 shadow-sm">
      <h3 class="text-lg font-semibold text-slate-800">Distribución actual</h3>
      <p class="mt-1 text-sm text-slate-500">Una fotografía equilibrada de las cargas de trabajo.</p>
      <div class="mt-6 flex items-center justify-center">
        <div class="relative h-60 w-60 sm:h-64 sm:w-64">
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </article>
  </section>

  <section class="rounded-3xl border border-slate-200 bg-white p-6 md:p-8 shadow-sm">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Tickets urgentes</h2>
        <p class="text-sm text-slate-500">Ordenados por prioridad y tiempo restante para actuar.</p>
      </div>
      <span class="inline-flex items-center gap-2 rounded-full bg-rose-50 px-4 py-1 text-xs font-medium text-rose-500">
        <i class="bi bi-lightning-charge-fill text-sm"></i>
        Atención prioritaria
      </span>
    </div>
    {% if urgent_tickets %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-400 uppercase text-xs tracking-wide">
              <th class="pb-3 pr-3">Código</th>
              <th class="pb-3 pr-3">Título</th>
              <th class="pb-3 pr-3">Prioridad</th>
              <th class="pb-3 pr-3">Asignado</th>
              <th class="pb-3">Horas restantes</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for ticket in urgent_tickets %}
            <tr class="transition duration-200 hover:bg-rose-50/80">
              <td class="py-3 pr-3 font-semibold text-slate-700">
                <a href="{% url 'ticket_detail' ticket.id %}">{{ ticket.code }}</a>
              </td>
              <td class="py-3 pr-3 text-slate-600">{{ ticket.title }}</td>
              <td class="py-3 pr-3">
                <span class="inline-flex items-center gap-1 rounded-full bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-600">
                  <i class="bi bi-exclamation-triangle-fill"></i>
                  {{ ticket.priority.name }}
                </span>
              </td>
              <td class="py-3 pr-3 text-slate-500">{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}-{% endif %}</td>
              <td class="py-3 text-slate-700 font-semibold">{{ ticket.remaining_hours|floatformat:1 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-6 text-center text-sm text-emerald-600">
        <i class="bi bi-emoji-smile text-lg mr-1"></i>
        No hay tickets urgentes en este momento.
      </div>
    {% endif %}
  </section>

  <section class="rounded-3xl border border-slate-200 bg-white p-6 md:p-8 shadow-sm">
    <div class="flex flex-col gap-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold text-slate-900">Tendencias de fallas</h2>
          <p class="text-sm text-slate-500">Explora las categorías que generan más incidencias recientes y prioriza acciones preventivas.</p>
        </div>
        {% if has_failures_data %}
          <span class="text-xs text-slate-400">Datos recopilados desde {{ failures_since|localtime|date:"d/m/Y" }}.</span>
        {% endif %}
      </div>

      {% if has_failures_data %}
        <div class="grid grid-cols-1 xl:grid-cols-[2.2fr_1fr] gap-6">
          <div class="rounded-2xl border border-slate-100 bg-slate-50 p-5">
            <div class="relative h-72 sm:h-80">
              <canvas id="failuresChart"></canvas>
            </div>
          </div>
          <div class="rounded-2xl border border-slate-100 bg-white p-5">
            <h3 class="text-lg font-semibold text-slate-800 mb-3">Fallas más comunes</h3>
            <p class="text-xs text-slate-500 mb-4">Top de categorías detectadas en los últimos 60 días.</p>
            <ul class="space-y-3">
              {% for failure in failure_breakdown %}
              <li class="flex items-center justify-between rounded-xl border border-slate-100 bg-slate-50 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-9 w-9 items-center justify-center rounded-full text-xs font-semibold text-slate-700" style="background-color: {{ failure.color }}33; border: 1px solid {{ failure.color }}55;">
                    {{ forloop.counter }}
                  </span>
                  <span class="text-sm font-medium text-slate-600">{{ failure.label }}</span>
                </div>
                <span class="text-sm font-semibold text-slate-700">{{ failure.total }}</span>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% else %}
        <div class="rounded-2xl border border-indigo-200 bg-indigo-50 p-6 text-center text-sm text-indigo-600">
          <i class="bi bi-info-circle-fill text-base mr-1"></i>
          No hay registros recientes suficientes para mostrar tendencias de fallas.
        </div>
      {% endif %}
    </div>
  </section>
</div>

{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusConfig = {{ chart_data|safe }};
    const failuresConfig = {{ failures_chart_data|safe }};
    const hasFailureData = {{ has_failures_data|yesno:"true,false" }};

    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: statusConfig.labels,
          datasets: [{
            data: statusConfig.data,
            backgroundColor: ['#cfe6ff', '#ffe6c7', '#c7f2f2', '#dcd9ff'],
            borderColor: '#ffffff',
            borderWidth: 3,
            hoverOffset: 12,
          }],
        },
        options: {
          cutout: '62%',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 18,
                color: '#475569',
                font: { size: 13, family: '"Inter", ui-sans-serif, system-ui' },
              },
            },
            tooltip: {
              backgroundColor: '#0f172a',
              titleColor: '#f8fafc',
              bodyColor: '#e2e8f0',
              padding: 12,
              cornerRadius: 12,
            },
          },
        },
      });
    }

    if (hasFailureData) {
      const failureCtx = document.getElementById('failuresChart');
      if (failureCtx) {
        new Chart(failureCtx, {
          type: 'line',
          data: {
            labels: failuresConfig.labels,
            datasets: [{
              label: 'Tickets',
              data: failuresConfig.data,
              backgroundColor: 'rgba(96, 165, 250, 0.25)',
              borderColor: 'rgba(59, 130, 246, 0.9)',
              borderWidth: 2,
              pointBackgroundColor: '#60a5fa',
              pointBorderColor: '#fff',
              pointRadius: 4,
              pointHoverRadius: 6,
              fill: true,
              tension: 0.35,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                backgroundColor: '#0f172a',
                titleColor: '#f8fafc',
                bodyColor: '#e2e8f0',
                padding: 12,
                cornerRadius: 12,
              },
            },
            scales: {
              x: {
                ticks: {
                  color: '#64748b',
                  font: { size: 11 },
                  maxRotation: 0,
                  minRotation: 0,
                },
                grid: {
                  color: 'rgba(148, 163, 184, 0.18)',
                },
              },
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  color: '#64748b',
                },
                grid: {
                  color: 'rgba(203, 213, 225, 0.3)',
                },
              },
            },
          },
        });
      }
    }
  });
</script>
{% endblock %}
