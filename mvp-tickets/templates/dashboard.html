{% extends "base.html" %}
{% load tz %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-10">
  <div>
    <h1 class="text-3xl font-semibold text-slate-800 mb-2">Dashboard</h1>
    <p class="text-gray-600 max-w-3xl">Un vistazo {{ scope }} a lo que está ocurriendo en el helpdesk en este momento.</p>
  </div>

  <section class="rounded-3xl border border-slate-200 bg-white/90 p-6 md:p-8 shadow-xl">
    <div class="flex flex-col gap-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-semibold text-slate-800">Estado general de los tickets</h2>
          <p class="mt-1 text-sm text-slate-500">Una vista rápida de la distribución y volúmenes clave para cada estado.</p>
        </div>
        <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-4 py-1 text-xs font-medium text-slate-600">
          <i class="bi bi-activity text-sm"></i>
          Actualizado en tiempo real
        </span>
      </div>
      <div class="grid grid-cols-1 xl:grid-cols-5 gap-6 items-stretch">
        <div class="xl:col-span-2 flex justify-center">
          <div class="relative h-64 w-64 sm:h-72 sm:w-72 lg:h-80 lg:w-80">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
        <div class="xl:col-span-3">
          <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4 h-full">
            <div class="relative overflow-hidden rounded-3xl border border-blue-100 bg-blue-50/80 shadow-lg">
              <div class="absolute inset-0 bg-gradient-to-r from-blue-100 via-blue-50 to-white opacity-80"></div>
              <div class="relative flex items-center gap-4 px-5 py-5">
                <span class="flex h-12 w-12 items-center justify-center rounded-full bg-blue-500/20 text-2xl text-blue-600 shadow-inner">
                  <i class="bi bi-ticket-perforated"></i>
                </span>
                <div class="flex-1">
                  <p class="text-xs font-semibold text-blue-500 uppercase tracking-[0.2em]">Abiertos</p>
                  <p class="text-3xl font-bold text-slate-900 leading-tight">{{ counts.open }}</p>
                  <p class="text-xs text-slate-500">Tickets que necesitan tu magia ahora mismo.</p>
                </div>
              </div>
            </div>
            <div class="relative overflow-hidden rounded-3xl border border-amber-100 bg-amber-50/80 shadow-lg">
              <div class="absolute inset-0 bg-gradient-to-r from-amber-100 via-amber-50 to-white opacity-80"></div>
              <div class="relative flex items-center gap-4 px-5 py-5">
                <span class="flex h-12 w-12 items-center justify-center rounded-full bg-amber-500/20 text-2xl text-amber-500 shadow-inner">
                  <i class="bi bi-play-circle"></i>
                </span>
                <div class="flex-1">
                  <p class="text-xs font-semibold text-amber-500 uppercase tracking-[0.2em]">En progreso</p>
                  <p class="text-3xl font-bold text-slate-900 leading-tight">{{ counts.in_progress }}</p>
                  <p class="text-xs text-slate-500">Trabajándose con energía a tope.</p>
                </div>
              </div>
            </div>
            <div class="relative overflow-hidden rounded-3xl border border-emerald-100 bg-emerald-50/80 shadow-lg">
              <div class="absolute inset-0 bg-gradient-to-r from-emerald-100 via-emerald-50 to-white opacity-80"></div>
              <div class="relative flex items-center gap-4 px-5 py-5">
                <span class="flex h-12 w-12 items-center justify-center rounded-full bg-emerald-500/20 text-2xl text-emerald-600 shadow-inner">
                  <i class="bi bi-check-circle"></i>
                </span>
                <div class="flex-1">
                  <p class="text-xs font-semibold text-emerald-600 uppercase tracking-[0.2em]">Resueltos (mes)</p>
                  <p class="text-3xl font-bold text-slate-900 leading-tight">{{ counts.resolved }}</p>
                  <p class="text-xs text-slate-500">Historias de éxito fresco saliendo del horno.</p>
                </div>
              </div>
            </div>
            <div class="relative overflow-hidden rounded-3xl border border-slate-200 bg-slate-50/80 shadow-lg">
              <div class="absolute inset-0 bg-gradient-to-r from-slate-200 via-slate-50 to-white opacity-80"></div>
              <div class="relative flex items-center gap-4 px-5 py-5">
                <span class="flex h-12 w-12 items-center justify-center rounded-full bg-slate-500/15 text-2xl text-slate-600 shadow-inner">
                  <i class="bi bi-archive"></i>
                </span>
                <div class="flex-1">
                  <p class="text-xs font-semibold text-slate-600 uppercase tracking-[0.2em]">Cerrados (mes)</p>
                  <p class="text-3xl font-bold text-slate-900 leading-tight">{{ counts.closed }}</p>
                  <p class="text-xs text-slate-500">Trabajo impecable para presumir al equipo.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6 md:p-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl font-semibold text-slate-800">Tickets urgentes</h2>
        <p class="text-sm text-slate-500">Ordenados por prioridad y tiempo restante para actuar.</p>
      </div>
      <span class="inline-flex items-center gap-2 rounded-full bg-rose-100 px-4 py-1 text-xs font-medium text-rose-600">
        <i class="bi bi-lightning-charge-fill text-sm"></i>
        Atención prioritaria
      </span>
    </div>
    {% if urgent_tickets %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-400 uppercase text-xs tracking-wide">
              <th class="pb-3 pr-3">Código</th>
              <th class="pb-3 pr-3">Título</th>
              <th class="pb-3 pr-3">Prioridad</th>
              <th class="pb-3 pr-3">Asignado</th>
              <th class="pb-3">Horas restantes</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for ticket in urgent_tickets %}
            <tr class="transition hover:bg-slate-50/70">
              <td class="py-3 pr-3 font-semibold text-blue-600">
                <a href="{% url 'ticket_detail' ticket.id %}">{{ ticket.code }}</a>
              </td>
              <td class="py-3 pr-3 text-slate-700">{{ ticket.title }}</td>
              <td class="py-3 pr-3">
                <span class="inline-flex items-center rounded-full bg-amber-100 px-3 py-1 text-xs font-medium text-amber-700">{{ ticket.priority.name }}</span>
              </td>
              <td class="py-3 pr-3 text-slate-600">{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}-{% endif %}</td>
              <td class="py-3 text-slate-700">{{ ticket.remaining_hours|floatformat:1 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="rounded-2xl border border-emerald-100 bg-emerald-50/60 p-6 text-center text-sm text-emerald-700">
        <i class="bi bi-emoji-smile text-lg mr-1"></i>
        No hay tickets urgentes en este momento.
      </div>
    {% endif %}
  </section>

  <section class="bg-white rounded-3xl shadow-xl border border-slate-100 p-6 md:p-8">
    <div class="flex flex-col gap-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold text-slate-800">Tendencias de fallas</h2>
          <p class="text-sm text-slate-500">Explora las categorías que generan más incidencias recientes y prioriza acciones preventivas.</p>
        </div>
        {% if has_failures_data %}
          <span class="text-xs text-slate-400">Datos recopilados desde {{ failures_since|localtime|date:"d/m/Y" }}.</span>
        {% endif %}
      </div>

      {% if has_failures_data %}
        <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
          <div class="xl:col-span-3">
            <div class="relative h-72 sm:h-80">
              <canvas id="failuresChart"></canvas>
            </div>
          </div>
          <div class="xl:col-span-2">
            <div class="rounded-2xl border border-slate-100 bg-slate-50/70 p-5">
              <h3 class="text-lg font-semibold text-slate-800 mb-3">Fallas más comunes</h3>
              <p class="text-xs text-slate-500 mb-4">Top de categorías detectadas en los últimos 60 días.</p>
              <ul class="space-y-3">
                {% for failure in failure_breakdown %}
                <li class="flex items-center justify-between rounded-2xl border border-white/60 bg-white/90 px-4 py-3 shadow-sm">
                  <div class="flex items-center gap-3">
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-full text-xs font-semibold text-white" style="background-color: {{ failure.color }};">
                      {{ forloop.counter }}
                    </span>
                    <span class="text-sm font-medium text-slate-700">{{ failure.label }}</span>
                  </div>
                  <span class="text-sm font-semibold text-slate-900">{{ failure.total }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% else %}
        <div class="rounded-2xl border border-indigo-100 bg-indigo-50/60 p-6 text-center text-sm text-indigo-700">
          <i class="bi bi-info-circle-fill text-base mr-1"></i>
          No hay registros recientes suficientes para mostrar tendencias de fallas.
        </div>
      {% endif %}
    </div>
  </section>
</div>

{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusConfig = {{ chart_data|safe }};
    const failuresConfig = {{ failures_chart_data|safe }};
    const hasFailureData = {{ has_failures_data|yesno:"true,false" }};

    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
      const statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
          labels: statusConfig.labels,
          datasets: [{
            data: statusConfig.data,
            backgroundColor: ['#2563eb', '#f59e0b', '#10b981', '#64748b'],
            borderColor: '#ffffff',
            borderWidth: 3,
            hoverOffset: 16,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 18,
                color: '#0f172a',
                font: { size: 13, family: 'Poppins, ui-sans-serif, system-ui' },
              },
            },
            tooltip: {
              backgroundColor: '#0f172a',
              titleColor: '#f8fafc',
              bodyColor: '#f8fafc',
              padding: 14,
              cornerRadius: 14,
            },
          },
        },
      });

      statusCtx.style.filter = 'drop-shadow(0 18px 35px rgba(15, 23, 42, 0.18))';
    }

    if (hasFailureData) {
      const failureCtx = document.getElementById('failuresChart');
      if (failureCtx) {
        new Chart(failureCtx, {
          type: 'bar',
          data: {
            labels: failuresConfig.labels,
            datasets: [{
              label: 'Tickets',
              data: failuresConfig.data,
              backgroundColor: failuresConfig.colors,
              borderRadius: 14,
              borderSkipped: false,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#111827',
                titleColor: '#f1f5f9',
                bodyColor: '#f1f5f9',
                padding: 10,
                cornerRadius: 10,
              },
            },
            scales: {
              x: {
                ticks: {
                  color: '#475569',
                  font: { size: 11 },
                  maxRotation: 35,
                  minRotation: 0,
                },
                grid: { display: false },
              },
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  color: '#475569',
                },
                grid: {
                  color: 'rgba(148, 163, 184, 0.15)',
                },
              },
            },
          },
        });
      }
    }
  });
</script>
{% endblock %}
