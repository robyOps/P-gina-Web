{% extends "base.html" %}
{% load tz %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-10">
  <div class="rounded-3xl bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 p-8 shadow-2xl shadow-slate-900/40">
    <h1 class="text-3xl md:text-4xl font-semibold text-white mb-3 tracking-tight">Dashboard</h1>
    <p class="text-slate-200/90 max-w-3xl">Un vistazo {{ scope }} a lo que está ocurriendo en el helpdesk en este momento.</p>
  </div>

  <section class="rounded-3xl border border-slate-800/30 bg-slate-900/90 backdrop-blur-sm p-6 md:p-8 shadow-2xl shadow-slate-900/40 text-slate-100">
    <div class="flex flex-col gap-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3">
        <div>
          <h2 class="text-2xl font-semibold text-white">Estado general de los tickets</h2>
          <p class="mt-1 text-sm text-slate-300">Una vista rápida de la distribución y volúmenes clave para cada estado.</p>
        </div>
        <span class="inline-flex items-center gap-2 rounded-full bg-emerald-400/20 px-4 py-1 text-xs font-medium text-emerald-200">
          <i class="bi bi-activity text-sm"></i>
          Actualizado en tiempo real
        </span>
      </div>
      <div class="flex flex-col gap-6">
        <div class="overflow-x-auto pb-2">
          <div class="flex gap-4 min-w-max pr-2">
            <article class="group flex w-64 flex-col rounded-3xl border border-sky-500/50 bg-gradient-to-br from-sky-500/20 via-sky-500/10 to-sky-400/20 p-6 shadow-lg transition-transform duration-300 hover:-translate-y-1 hover:shadow-sky-500/40">
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold uppercase tracking-[0.35em] text-sky-200">Abiertos</span>
                <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-sky-500/20 text-2xl text-sky-100">
                  <i class="bi bi-envelope-open"></i>
                </span>
              </div>
              <p class="mt-4 text-4xl font-semibold text-white drop-shadow">{{ counts.open }}</p>
            </article>
            <article class="group flex w-64 flex-col rounded-3xl border border-amber-500/50 bg-gradient-to-br from-amber-500/20 via-amber-500/10 to-amber-400/20 p-6 shadow-lg transition-transform duration-300 hover:-translate-y-1 hover:shadow-amber-500/40">
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold uppercase tracking-[0.35em] text-amber-200">En progreso</span>
                <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-amber-500/20 text-2xl text-amber-100">
                  <i class="bi bi-hourglass-split"></i>
                </span>
              </div>
              <p class="mt-4 text-4xl font-semibold text-white drop-shadow">{{ counts.in_progress }}</p>
            </article>
            <article class="group flex w-64 flex-col rounded-3xl border border-emerald-500/50 bg-gradient-to-br from-emerald-500/20 via-emerald-500/10 to-emerald-400/20 p-6 shadow-lg transition-transform duration-300 hover:-translate-y-1 hover:shadow-emerald-500/40">
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200">Resueltos</span>
                <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-emerald-500/20 text-2xl text-emerald-100">
                  <i class="bi bi-patch-check"></i>
                </span>
              </div>
              <p class="mt-4 text-4xl font-semibold text-white drop-shadow">{{ counts.resolved }}</p>
            </article>
            <article class="group flex w-64 flex-col rounded-3xl border border-indigo-500/50 bg-gradient-to-br from-indigo-500/20 via-indigo-500/10 to-indigo-400/20 p-6 shadow-lg transition-transform duration-300 hover:-translate-y-1 hover:shadow-indigo-500/40">
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold uppercase tracking-[0.35em] text-indigo-200">Cerrados</span>
                <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-indigo-500/20 text-2xl text-indigo-100">
                  <i class="bi bi-archive-fill"></i>
                </span>
              </div>
              <p class="mt-4 text-4xl font-semibold text-white drop-shadow">{{ counts.closed }}</p>
            </article>
          </div>
        </div>
        <div class="flex justify-center">
          <div class="relative h-64 w-64 sm:h-72 sm:w-72 lg:h-80 lg:w-80">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="rounded-3xl border border-rose-500/30 bg-gradient-to-br from-rose-950 via-rose-900 to-rose-950 p-6 md:p-8 shadow-2xl shadow-rose-900/40 text-rose-50">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl font-semibold text-white">Tickets urgentes</h2>
        <p class="text-sm text-rose-200">Ordenados por prioridad y tiempo restante para actuar.</p>
      </div>
      <span class="inline-flex items-center gap-2 rounded-full bg-rose-500/20 px-4 py-1 text-xs font-medium text-rose-100">
        <i class="bi bi-lightning-charge-fill text-sm"></i>
        Atención prioritaria
      </span>
    </div>
    {% if urgent_tickets %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-rose-200 uppercase text-xs tracking-wide">
              <th class="pb-3 pr-3">Código</th>
              <th class="pb-3 pr-3">Título</th>
              <th class="pb-3 pr-3">Prioridad</th>
              <th class="pb-3 pr-3">Asignado</th>
              <th class="pb-3">Horas restantes</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-rose-500/20">
            {% for ticket in urgent_tickets %}
            <tr class="transition duration-300 hover:bg-rose-500/10">
              <td class="py-3 pr-3 font-semibold text-rose-200">
                <a href="{% url 'ticket_detail' ticket.id %}">{{ ticket.code }}</a>
              </td>
              <td class="py-3 pr-3 text-rose-100">{{ ticket.title }}</td>
              <td class="py-3 pr-3">
                <span class="inline-flex items-center gap-1 rounded-full bg-rose-600/20 px-3 py-1 text-xs font-semibold text-rose-100">
                  <i class="bi bi-exclamation-triangle-fill text-rose-200"></i>
                  {{ ticket.priority.name }}
                </span>
              </td>
              <td class="py-3 pr-3 text-rose-200">{% if ticket.assigned_to %}{{ ticket.assigned_to.username }}{% else %}-{% endif %}</td>
              <td class="py-3 text-rose-100 font-semibold">{{ ticket.remaining_hours|floatformat:1 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="rounded-2xl border border-emerald-300/40 bg-emerald-500/10 p-6 text-center text-sm text-emerald-100">
        <i class="bi bi-emoji-smile text-lg mr-1"></i>
        No hay tickets urgentes en este momento.
      </div>
    {% endif %}
  </section>

  <section class="rounded-3xl border border-slate-800/30 bg-slate-900/90 backdrop-blur-sm p-6 md:p-8 shadow-2xl shadow-slate-900/40 text-slate-100">
    <div class="flex flex-col gap-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold text-white">Tendencias de fallas</h2>
          <p class="text-sm text-slate-300">Explora las categorías que generan más incidencias recientes y prioriza acciones preventivas.</p>
        </div>
        {% if has_failures_data %}
          <span class="text-xs text-slate-400">Datos recopilados desde {{ failures_since|localtime|date:"d/m/Y" }}.</span>
        {% endif %}
      </div>

      {% if has_failures_data %}
        <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
          <div class="xl:col-span-3">
            <div class="relative h-72 sm:h-80">
              <canvas id="failuresChart"></canvas>
            </div>
          </div>
          <div class="xl:col-span-2">
            <div class="rounded-2xl border border-slate-700/40 bg-slate-900/80 p-5 shadow-inner shadow-black/20">
              <h3 class="text-lg font-semibold text-white mb-3">Fallas más comunes</h3>
              <p class="text-xs text-slate-300 mb-4">Top de categorías detectadas en los últimos 60 días.</p>
              <ul class="space-y-3">
                {% for failure in failure_breakdown %}
                <li class="flex items-center justify-between rounded-2xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 shadow-lg shadow-black/10">
                  <div class="flex items-center gap-3">
                    <span class="inline-flex h-9 w-9 items-center justify-center rounded-full text-xs font-semibold text-white shadow-lg shadow-black/30" style="background-color: {{ failure.color }};">
                      {{ forloop.counter }}
                    </span>
                    <span class="text-sm font-medium text-slate-100">{{ failure.label }}</span>
                  </div>
                  <span class="text-sm font-semibold text-white">{{ failure.total }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% else %}
        <div class="rounded-2xl border border-indigo-500/30 bg-indigo-900/50 p-6 text-center text-sm text-indigo-100">
          <i class="bi bi-info-circle-fill text-base mr-1"></i>
          No hay registros recientes suficientes para mostrar tendencias de fallas.
        </div>
      {% endif %}
    </div>
  </section>
</div>

{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusConfig = {{ chart_data|safe }};
    const failuresConfig = {{ failures_chart_data|safe }};
    const hasFailureData = {{ has_failures_data|yesno:"true,false" }};

    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
      const statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
          labels: statusConfig.labels,
          datasets: [{
            data: statusConfig.data,
            backgroundColor: ['#38bdf8', '#f97316', '#22d3ee', '#6366f1'],
            borderColor: '#020617',
            borderWidth: 4,
            hoverOffset: 18,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 18,
                color: '#e2e8f0',
                font: { size: 13, family: 'Poppins, ui-sans-serif, system-ui' },
              },
            },
            tooltip: {
              backgroundColor: '#020617',
              titleColor: '#f8fafc',
              bodyColor: '#cbd5f5',
              padding: 14,
              cornerRadius: 16,
            },
          },
        },
      });

      statusCtx.style.filter = 'drop-shadow(0 22px 45px rgba(8, 47, 73, 0.45))';
    }

    if (hasFailureData) {
      const failureCtx = document.getElementById('failuresChart');
      if (failureCtx) {
        new Chart(failureCtx, {
          type: 'bar',
          data: {
            labels: failuresConfig.labels,
            datasets: [{
              label: 'Tickets',
              data: failuresConfig.data,
              backgroundColor: failuresConfig.colors,
              borderColor: '#0f172a',
              borderWidth: 2,
              borderRadius: 18,
              borderSkipped: false,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#020617',
                titleColor: '#f8fafc',
                bodyColor: '#cbd5f5',
                padding: 12,
                cornerRadius: 14,
              },
            },
            scales: {
              x: {
                ticks: {
                  color: '#cbd5f5',
                  font: { size: 11 },
                  maxRotation: 35,
                  minRotation: 0,
                },
                grid: { display: false },
              },
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  color: '#cbd5f5',
                },
                grid: {
                  color: 'rgba(148, 163, 184, 0.18)',
                },
              },
            },
          },
        });
      }
    }
  });
</script>
{% endblock %}
