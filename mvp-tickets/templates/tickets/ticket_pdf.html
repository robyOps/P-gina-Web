<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>{{ t.code }} · Resumen del ticket</title>
  <style>
    body {
      font-family: "DejaVu Sans", Arial, Helvetica, sans-serif;
      font-size: 12px;
      color: #0f172a;
      background: #f8fafc;
      margin: 0;
      padding: 24px;
    }
    .paper {
      background: #ffffff;
      border: 1px solid #dbe3f3;
      border-radius: 16px;
      padding: 24px 28px;
      box-sizing: border-box;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
      color: #111827;
    }
    h2 {
      font-size: 14px;
      color: #1f2937;
      margin: 24px 0 10px;
      padding-bottom: 4px;
      border-bottom: 1px solid #e2e8f0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 6px 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #475569;
      background: #f1f5f9;
    }
    td {
      font-size: 12px;
    }
    .muted {
      color: #64748b;
      font-size: 11px;
    }
    .summary-grid {
      width: 100%;
      margin-top: 12px;
    }
    .summary-grid th {
      width: 26%;
    }
    .header-meta {
      font-size: 11px;
      color: #475569;
      margin-bottom: 4px;
    }
    .chips {
      margin: 8px 0 0;
      padding: 0;
      list-style: none;
    }
    .chips li {
      display: inline-block;
      margin: 0 6px 6px 0;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 999px;
      background: #e0e7ff;
      color: #3730a3;
    }
    .description {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px;
      line-height: 1.55;
      white-space: pre-line;
      background: #f8fafc;
    }
    .badge-row {
      margin: 12px 0 18px;
      font-size: 11px;
      color: #1f2937;
    }
    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: 4px 12px;
      margin-right: 6px;
      background: #eef2ff;
      color: #3730a3;
      font-weight: 600;
    }
    .section {
      margin-bottom: 10px;
    }
    .footnote {
      font-size: 10px;
      color: #94a3b8;
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <div class="paper">
    <div class="section">
      <div class="header-meta">Ticket {{ t.code }} · Generado el {{ generated_at|date:"d/m/Y H:i" }} · Usuario: {{ request.user.username }}</div>
      <h1>{{ t.title }}</h1>
      <div class="badge-row">
        <span class="badge">Estado: {{ t.get_status_display }}</span>
        <span class="badge">Prioridad: {{ t.priority.name }}</span>
        <span class="badge">Tipo: {{ t.get_kind_display }}</span>
      </div>
      <div class="muted">
        Solicitante: {{ t.requester.username }}{% if t.assigned_to %} · Técnico asignado: {{ t.assigned_to.username }}{% endif %}
      </div>
    </div>

    <div class="section">
      <h2>Resumen del caso</h2>
      <table class="summary-grid">
        <tr>
          <th>Categoría</th>
          <td>{{ t.category.name }}</td>
          <th>Subcategoría</th>
          <td>{% if t.subcategory %}{{ t.subcategory.name }}{% else %}<span class="muted">Sin subcategoría</span>{% endif %}</td>
        </tr>
        <tr>
          <th>Área relacionada</th>
          <td>{% if t.area %}{{ t.area.name }}{% else %}<span class="muted">Sin área asociada</span>{% endif %}</td>
          <th>SLA</th>
          <td>{% if t.resolved_at %}Cumplido el {{ t.resolved_at|date:"d/m/Y H:i" }}{% else %}Vence {{ t.due_at|date:"d/m/Y H:i" }}{% endif %}</td>
        </tr>
        <tr>
          <th>Creado</th>
          <td>{{ t.created_at|date:"d/m/Y H:i" }}</td>
          <th>Última actualización</th>
          <td>{{ t.updated_at|date:"d/m/Y H:i" }}</td>
        </tr>
        <tr>
          <th>Resuelto</th>
          <td>{% if t.resolved_at %}{{ t.resolved_at|date:"d/m/Y H:i" }}{% else %}<span class="muted">Pendiente</span>{% endif %}</td>
          <th>Cerrado</th>
          <td>{% if t.closed_at %}{{ t.closed_at|date:"d/m/Y H:i" }}{% else %}<span class="muted">Pendiente</span>{% endif %}</td>
        </tr>
      </table>
      {% if labels %}
        <ul class="chips">
          {% for label in labels %}
            <li>{{ label.name }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="section">
      <h2>Descripción</h2>
      <div class="description">{{ t.description }}</div>
    </div>

    {% if public_comments %}
    <div class="section">
      <h2>Comentarios visibles</h2>
      <table>
        <thead>
          <tr>
            <th>Autor</th>
            <th>Fecha</th>
            <th>Detalle</th>
          </tr>
        </thead>
        <tbody>
          {% for c in public_comments %}
          <tr>
            <td>{{ c.author.username }}</td>
            <td>{{ c.created_at|date:"d/m/Y H:i" }}</td>
            <td>{{ c.body|linebreaksbr }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    {% if attachments %}
    <div class="section">
      <h2>Archivos adjuntos</h2>
      <table>
        <thead>
          <tr>
            <th>Archivo</th>
            <th>Peso</th>
            <th>Subido por</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          {% for a in attachments %}
          <tr>
            <td>{{ a.file.name }}</td>
            <td>{% if a.size %}{{ a.size|filesizeformat }}{% else %}<span class="muted">—</span>{% endif %}</td>
            <td>{{ a.uploaded_by.username }}</td>
            <td>{{ a.uploaded_at|date:"d/m/Y H:i" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <p class="footnote">Documento generado automáticamente desde la mesa de ayuda.</p>
  </div>
</body>
</html>
